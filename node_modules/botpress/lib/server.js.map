{"version":3,"sources":["../src/server.js"],"names":["setupSocket","server","bp","io","botfile","login","enabled","security","getSecret","secret","handshake","authorize","use","on","socket","stats","track","event","events","emit","name","data","onAny","from","serveApi","app","logsSecret","v4","routersConditions","maybeApply","fn","req","res","next","router","originalUrl","match","condition","json","urlencoded","extended","post","body","user","password","ip","result","send","authenticationMiddleware","get","modules","map","_loadedModules","module","homepage","menuText","settings","menuIcon","noInterface","middlewares","list","setCustomizations","load","delete","resetCustomizations","notifications","about","getBotInformation","listAllCommunityModules","then","listPopularCommunityModules","popular","listFeaturedCommunityModules","featured","getRandomCommunityHero","hero","bot","getInformation","isDeveloping","getContributor","licensing","getLicenses","changeLicense","license","sendStatus","catch","status","message","err","params","install","restart","uninstall","unlink","join","projectLocation","isFirstRun","options","Date","until","limit","query","start","order","fields","logger","results","console","log","file","key","archiveToFile","archivePath","download","routers","getRouter","conditions","test","Error","Router","Object","assign","serveStatic","bundlePath","root","webBundle","requestPath","iconRequestPath","iconPath","content","readFileSync","contentType","warn","tokenExpiry","optOutStats","version","process","env","NODE_ENV","customTheme","themeLocation","existsSync","compile","renderSync","css","toString","static","__dirname","headers","accept","sendFile","resolve","authenticate","authorization","location","end","WebServer","botpress","createServer","port","listen","values","mod","handlers","ready","configuration","info","green","bold","exports"],"mappings":"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","file":"server.js","sourcesContent":["import express from 'express'\nimport path from 'path'\nimport Promise from 'bluebird'\nimport _ from 'lodash'\nimport fs from 'fs'\nimport socketio from 'socket.io'\nimport socketioJwt from 'socketio-jwt'\nimport http from 'http'\nimport bodyParser from 'body-parser'\nimport ms from 'ms'\nimport chalk from 'chalk'\nimport uuid from 'uuid'\nimport sass from 'node-sass'\n\nimport util from './util'\n\nconst setupSocket = async function(server, bp) {\n  const io = socketio(server)\n\n  if (bp.botfile.login.enabled) {\n    io.use(socketioJwt.authorize({\n      secret: await bp.security.getSecret(),\n      handshake: true\n    }))\n  }\n\n  io.on('connection', function(socket) {\n    bp.stats.track('socket', 'connected')\n\n    socket.on('event', function(event) {\n      bp.events.emit(event.name, event.data, 'client')\n    })\n  })\n\n  bp.events.onAny(function(event, data, from) {\n    if (from === 'client') {\n      // we sent this ourselves\n      return\n    }\n    io.emit('event', {\n      name: event,\n      data: data\n    })\n  })\n\n  return server\n}\n\nconst serveApi = function(app, bp) {\n  let logsSecret = uuid.v4()\n  const routersConditions = {}\n  const maybeApply = (name, fn) => {\n    return (req, res, next) => {\n      const router = req.originalUrl.match(/\\/api\\/(botpress-[^\\/]+).*$/i)\n      if (!router) {\n        return fn(req, res, next)\n      }\n\n      if (!routersConditions[router[1]]) {\n        return fn(req, res, next)\n      }\n\n      const condition = routersConditions[router[1]][name]\n      if (condition === false) {\n        next()\n      } else if (typeof(condition) === 'function' && condition(req) === false) {\n        next()\n      } else {\n        return fn(req, res, next)\n      }\n    }\n  }\n\n  app.use(maybeApply('bodyParser.json', bodyParser.json()))\n  app.use(maybeApply('bodyParser.urlencoded', bodyParser.urlencoded({ extended: true })))\n\n  app.post('/api/login', async (req, res) => {\n    bp.stats.track('api', 'auth', 'login')\n    const result = await bp.security.login(req.body.user, req.body.password, req.ip)\n    res.send(result)\n  })\n\n  app.use('/api/*', maybeApply('auth', authenticationMiddleware(bp)))\n\n  app.get('/api/ping', (req, res) => {\n    res.send('pong')\n  })\n\n  app.get('/api/modules', (req, res) => {\n    const modules = _.map(bp._loadedModules, (module) => {\n      return {\n        name: module.name,\n        homepage: module.homepage,\n        menuText: module.settings.menuText || module.name,\n        menuIcon: module.settings.menuIcon || 'view_module',\n        noInterface: !!module.settings.noInterface\n      }\n    })\n    res.send(modules)\n  })\n\n  app.get('/api/middlewares', (req, res) => {\n    res.send(bp.middlewares.list())\n  })\n\n  app.post('/api/middlewares/customizations', (req, res) => {\n    bp.stats.track('api', 'middlewares', 'customizations')\n    const { middlewares } = req.body\n    bp.middlewares.setCustomizations(middlewares)\n    bp.middlewares.load()\n    res.send(bp.middlewares.list())\n  })\n\n  app.delete('/api/middlewares/customizations', (req, res) => {\n    bp.stats.track('api', 'middlewares', 'customizations')\n    bp.middlewares.resetCustomizations()\n    bp.middlewares.load()\n    res.send(bp.middlewares.list())\n  })\n\n  app.get('/api/notifications', (req, res) => {\n    res.send(bp.notifications.load())\n  })\n\n  app.get('/api/bot/information', (req, res) => {\n    res.send(bp.about.getBotInformation())\n  })\n\n  app.get('/api/module/all', (req, res) => {\n    bp.modules.listAllCommunityModules()\n    .then(modules => res.send(modules))\n  })\n\n  app.get('/api/module/popular', (req, res) => {\n    bp.modules.listPopularCommunityModules()\n    .then(popular => res.send(popular))\n  })\n\n  app.get('/api/module/featured', (req, res) => {\n    bp.modules.listFeaturedCommunityModules()\n    .then(featured => res.send(featured))\n  })\n\n  app.get('/api/module/hero', (req, res) => {\n    bp.modules.getRandomCommunityHero()\n    .then(hero => res.send(hero))\n  })\n\n  app.get('/api/bot/information', (req, res) => {\n    res.send(bp.bot.getInformation())\n  })\n\n  app.get('/api/bot/production', (req, res) => {\n    res.send(!util.isDeveloping)\n  })\n\n  app.get('/api/bot/contributor', (req, res) => {\n    res.send(bp.bot.getContributor())\n  })\n\n  app.get('/api/license', (req, res) => {\n    res.send(bp.licensing.getLicenses())\n  })\n\n  app.post('/api/license', (req, res) => {\n    bp.stats.track('api', 'license', 'change')\n    bp.licensing.changeLicense(req.body.license)\n    .then(() => {\n      res.sendStatus(200)\n    })\n    .catch(err => res.status(500).send({\n      message: err && err.message\n    }))\n  })\n\n  app.post('/api/module/install/:name', (req, res) => {\n    bp.stats.track('api', 'modules', 'install')\n    const { name } = req.params\n    bp.modules.install(name)\n    .then(() => {\n      res.sendStatus(200)\n      bp.restart(1000)\n    })\n    .catch(err => res.status(500).send({\n      message: err && err.message\n    }))\n  })\n\n  app.delete('/api/module/uninstall/:name', (req, res) => {\n    bp.stats.track('api', 'modules', 'uninstall')\n    const { name } = req.params\n    bp.modules.uninstall(name)\n    .then(() => {\n      res.sendStatus(200)\n      bp.restart(1000)\n    })\n    .catch(err => res.status(500).send({\n      message: err && err.message\n    }))\n  })\n\n  app.delete('/api/guided-tour', (req, res) => {\n    fs.unlink(path.join(bp.projectLocation, '.welcome'), () => {\n      bp.isFirstRun = false\n      res.sendStatus(200)\n    })\n  })\n\n  app.get('/api/logs', (req, res) => {\n    const options = {\n      from: new Date() - 7 * 24 * 60 * 60 * 1000,\n      until: new Date(),\n      limit: (req.query && req.query.limit) || 50,\n      start: 0,\n      order: 'desc',\n      fields: ['message', 'level', 'timestamp']\n    }\n    bp.logger.query(options, (err, results) => {\n      if (err) { return console.log(err) }\n      res.send(results.file)\n    })\n  })\n\n  app.get('/api/logs/key', (req, res) => {\n    res.send({ secret: logsSecret })\n  })\n\n  app.get('/logs/archive/:key', (req, res) => {\n    bp.stats.track('api', 'logs', 'archive')\n    if (req.params.key !== logsSecret) {\n      return res.sendStatus(403)\n    }\n\n    bp.logger.archiveToFile()\n    .then((archivePath) => {\n      logsSecret = uuid.v4()\n      res.download(archivePath)\n    })\n  })\n\n  const routers = {}\n  bp.getRouter = function(name, conditions) {\n\n    if (!/^botpress-/.test(name)) {\n      throw new Error(`The name of a router must start with 'botpress-'. Received: ${name}`)\n    }\n\n    if (!routers[name]) {\n      const router = express.Router()\n      routers[name] = router\n      app.use(`/api/${name}/`, router)\n    }\n\n    if (conditions) {\n      routersConditions[name] = Object.assign(routersConditions[name] || {}, conditions)\n    }\n\n    return routers[name]\n  }\n}\n\nconst serveStatic = function(app, bp) {\n\n  for (let name in bp._loadedModules) {\n    const module = bp._loadedModules[name]\n    const bundlePath = path.join(module.root, module.settings.webBundle || 'bin/web.bundle.js')\n    const requestPath = `/js/modules/${name}.js`\n\n    if (module.settings.menuIcon === 'custom') {\n      const iconRequestPath = `/img/modules/${name}.png`\n      const iconPath = path.join(module.root, 'icon.png')\n\n      app.use(iconRequestPath, (req, res) => {\n        try {\n          const content = fs.readFileSync(iconPath)\n          res.contentType('image/png')\n          res.send(content)\n        } catch (err) {\n          bp.logger.warn(`Could not serve module icon [${name}] at: ${iconPath}`)\n        }\n      })\n    }\n\n    app.use(requestPath, (req, res) => {\n      try {\n        const content = fs.readFileSync(bundlePath)\n        res.contentType('text/javascript')\n        res.send(content)\n      } catch (err) {\n        bp.logger.warn(`Could not serve module [${name}] at: ${bundlePath}`)\n      }\n    })\n  }\n\n  app.use('/js/env.js', (req, res) => {\n    const { tokenExpiry, enabled } = bp.botfile.login\n    const optOutStats = !!bp.botfile.optOutStats\n    const { isFirstRun, version } = bp\n    res.contentType('text/javascript')\n    res.send(`(function(window) {\n      window.NODE_ENV = \"${process.env.NODE_ENV || 'development'}\";\n      window.DEV_MODE = ${util.isDeveloping};\n      window.AUTH_ENABLED = ${enabled};\n      window.AUTH_TOKEN_DURATION = ${ms(tokenExpiry)};\n      window.OPT_OUT_STATS = ${optOutStats};\n      window.SHOW_GUIDED_TOUR = ${isFirstRun};\n      window.BOTPRESS_VERSION = \"${version}\";\n    })(window || {})`)\n  })\n\n  let customTheme = ''\n  const themeLocation = path.join(bp.projectLocation, 'theme.scss')\n  if (fs.existsSync(themeLocation)) {\n    const content = fs.readFileSync(themeLocation)\n    const compile = sass.renderSync({ data: `#app {${content}}` })\n    customTheme = compile.css.toString()\n  }\n\n  app.use('/style/custom-theme.css', (req, res) => {\n    res.contentType('text/css')\n    res.send(customTheme)\n  })\n\n  app.use(express.static(path.join(__dirname, '../lib/web')))\n\n  app.get('*', (req, res, next) => {\n    if (/html/i.test(req.headers.accept)) {\n      return res.sendFile(path.join(__dirname, '../lib/web/index.html'))\n    }\n    next()\n  })\n\n  return Promise.resolve(true)\n}\n\nconst authenticationMiddleware = bp => async function(req, res, next) {\n  if (!bp.botfile.login.enabled) {\n    return next()\n  }\n\n  if (await bp.security.authenticate(req.headers.authorization)) {\n    next()\n  } else {\n    res.status(401).location('/login').end()\n  }\n}\n\nclass WebServer {\n\n  constructor({ botpress }) {\n    this.bp = botpress\n  }\n\n  async start() {\n    const app = express()\n    const server = http.createServer(app)\n    const port = this.bp.botfile.port || 3000\n    \n    serveApi(app, this.bp)\n    await setupSocket(server, this.bp)\n    serveStatic(app, this.bp)\n\n    server.listen(port, () => {\n      this.bp.events.emit('ready')\n      for (var mod of _.values(this.bp._loadedModules)) {\n        mod.handlers.ready && mod.handlers.ready(this.bp, mod.configuration)\n      }\n\n      this.bp.logger.info(chalk.green.bold('Bot launched. Visit: http://localhost:' + port))\n    })\n  }\n\n}\n\nmodule.exports = WebServer\n"]}