{"version":3,"sources":["webpack:///webpack/bootstrap ae66f3695110db84926b","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"path\"","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///external \"uuid\"","webpack:///external \"bluebird\"","webpack:///./src/messenger.js","webpack:///external \"eventemitter2\"","webpack:///external \"crypto\"","webpack:///external \"node-fetch\"","webpack:///external \"body-parser\"","webpack:///./src/actions.js","webpack:///./src/outgoing.js","webpack:///./src/incoming.js","webpack:///external \"lru-cache\"","webpack:///./src/users.js","webpack:///./src/ngrok.js","webpack:///external \"ngrok\""],"names":["checkVersion","require","path","fs","_","uuid","Promise","Messenger","actions","outgoing","incoming","ngrok","messenger","outgoingPending","pending","outgoingMiddleware","event","next","platform","type","setValue","args","__id","message_id","ts","split","substr","timestamp","parseInt","mid","method","raw","waitDelivery","waitRead","apply","then","initializeMessenger","bp","configurator","loadAll","config","connected","resolve","logger","debug","getUrl","botfile","port","url","replace","setConfig","hostname","saveAll","getConfig","updateSettings","connect","notifications","send","level","message","catch","error","err","module","exports","applicationID","required","default","env","accessToken","appSecret","verifyToken","v4","validated","homepage","displayGetStarted","greetingMessage","persistentMenu","persistentMenuItems","validation","isArray","v","automaticallyMarkAsRead","targetAudience","targetAudienceOpenToSome","targetAudienceCloseToSome","trustedDomains","autoRespondGetStarted","autoResponse","autoResponseOption","autoResponseText","autoResponsePostback","init","__dirname","middlewares","register","name","order","handler","description","forIn","action","sendName","msg","arguments","Date","toISOString","Math","random","resolver","promise","reject","sendOutgoing","ready","on","events","emit","e","router","getRouter","get","req","res","post","body","sendStatus","status","disconnect","sendValidationRequest","json","packageJSON","JSON","parse","readFileSync","join","EventEmitter","crypto","fetch","bodyParser","normalizeString","str","toUpperCase","Error","app","test","originalUrl","use","verify","_verifyRequestSignature","bind","_initWebhook","Object","assign","_setupNewWebhook","_subscribePage","_unsubscribePage","recipientId","text","quickReplies","options","formattedQuickReplies","_formatQuickReplies","length","quick_replies","sendMessage","buttons","payload","template_type","formattedButtons","_formatButtons","sendTemplate","elements","attachment","isReusable","isBoolean","is_reusable","attachmentId","attachment_id","sendRequest","recipient","id","sender_action","typing","autoTimeout","timeout","sendTypingIndicator","headers","stringify","object_id","object","field","custom_fields","page_id","access_token","_handleFacebookResponse","endpoint","_handleEvent","token","response","milliseconds","isNaN","min","before","sendAction","delay","userId","console","log","setting","target_audience","audience_type","countriesWhitelist","countries","whitelist","countriesBlacklist","blacklist","createTargetAudienceSetting","domains","data","whitelisted_domains","oldDomains","setting_type","domain_action_type","sendThreadRequest","greeting","thread_state","call_to_actions","updateGetStarted","setGetStartedButton","deleteGetStartedButton","updateGreetingText","isEmpty","deleteGreetingText","setGreetingText","items","_reformatPersistentMenuItems","updatePersistentMenu","setPersistentMenu","deletePersistentMenu","updateTargetAudience","setTargetAudience","updateTrustedDomains","setWhitelistedDomains","thrown","contextifyError","context","factory","map","button","title","reply","content_type","image_url","sender","postback","quick_reply","errorMessage","statusText","finally","query","entry","forEach","messaging","is_echo","broadcastEchoes","_handleQuickReplyEvent","_handleMessageEvent","attachments","_handleAttachmentEvent","_handlePostbackEvent","delivery","read","account_linking","optin","referral","payment","buf","signature","hash","expectedHash","createHmac","update","digest","item","value","oAuthUrl","callback_url","verify_token","fields","validateUserId","validateText","validateQuickReplies","validateQuickReply","validateTyping","isNumber","validateAttachmentType","includes","toLowerCase","validateUrl","validateTemplatePayload","isPlainObject","validatePersistentMenu","element","createText","to","createAttachment","isNull","createTemplate","createTyping","createSeen","createPersistentMenu","delete","createGreetingText","createGetStarted","enabled","createWhitelistedDomains","every","isString","handlePromise","handleText","sendTextMessage","handleAttachment","sendAttachment","handleTemplate","handleTyping","handleSeen","handleGetStarted","handlePersistentMenu","handleGreetingText","handleWhitelistedDomains","users","messagesCache","max","maxAge","preprocessEvent","has","alreadyProcessed","set","getOrFetchUserProfile","sendIncoming","user","profile","att","mConfig","sendText","values","mids","watermark","toString","warn","ref","filename","dataLocation","loadUserProfiles","existsSync","saveUserProfiles","profiles","content","writeFileSync","userProfiles","cacheTs","getUserProfile","db","saveUser","gender","timezone","locale","picture_url","profile_pic","first_name","last_name","return","fromCallback","callback","u","stop"],"mappings":";;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,uBAAe;AACf;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;;;;;;;;;;;;;;;ACtCA,KAAMA,eAAe,mBAAAC,CAAQ,CAAR,CAArB;;AAEA,KAAMC,OAAO,mBAAAD,CAAQ,CAAR,CAAb;AACA,KAAME,KAAK,mBAAAF,CAAQ,CAAR,CAAX;AACA,KAAMG,IAAI,mBAAAH,CAAQ,CAAR,CAAV;AACA,KAAMI,OAAO,mBAAAJ,CAAQ,CAAR,CAAb;AACA,KAAMK,UAAU,mBAAAL,CAAQ,CAAR,CAAhB;;AAEA,KAAMM,YAAY,mBAAAN,CAAQ,CAAR,CAAlB;AACA,KAAMO,UAAU,mBAAAP,CAAQ,EAAR,CAAhB;AACA,KAAMQ,WAAW,mBAAAR,CAAQ,EAAR,CAAjB;AACA,KAAMS,WAAW,mBAAAT,CAAQ,EAAR,CAAjB;AACA,KAAMU,QAAQ,mBAAAV,CAAQ,EAAR,CAAd;;AAEA,KAAIW,YAAY,IAAhB;AACA,KAAMC,kBAAkBJ,SAASK,OAAjC;;AAEA,KAAMC,qBAAqB,SAArBA,kBAAqB,CAACC,KAAD,EAAQC,IAAR,EAAiB;AAC1C,OAAID,MAAME,QAAN,KAAmB,UAAvB,EAAmC;AACjC,YAAOD,MAAP;AACD;;AAED,OAAI,CAACR,SAASO,MAAMG,IAAf,CAAL,EAA2B;AACzB,YAAOF,KAAK,6BAA6BD,MAAMG,IAAxC,CAAP;AACD;;AAED,OAAMC,WAAW,SAAXA,QAAW;AAAA,YAAU,YAAa;AAAA,yCAATC,IAAS;AAATA,aAAS;AAAA;;AACtC,WAAIL,MAAMM,IAAN,IAAcT,gBAAgBG,MAAMM,IAAtB,CAAlB,EAA+C;;AAE7C,aAAID,QAAQA,KAAK,CAAL,CAAR,IAAmBA,KAAK,CAAL,EAAQE,UAA/B,EAA2C;AACzC,eAAIC,KAAKH,KAAK,CAAL,EAAQE,UAAR,CAAmBE,KAAnB,CAAyB,GAAzB,EAA8B,CAA9B,CAAT;AACAD,gBAAKA,MAAMA,GAAGE,MAAH,CAAU,CAAV,CAAX;AACAb,2BAAgBG,MAAMM,IAAtB,EAA4BK,SAA5B,GAAwCC,SAASJ,EAAT,CAAxC;AACAX,2BAAgBG,MAAMM,IAAtB,EAA4BO,GAA5B,GAAkCR,KAAK,CAAL,EAAQE,UAA1C;AACD;;AAED,aAAIO,WAAW,SAAX,KAAyBd,MAAMe,GAAN,CAAUC,YAAV,IAA0BhB,MAAMe,GAAN,CAAUE,QAA7D,CAAJ,EAA4E;AAC1E;AACD,UAFD,MAEO;AACLpB,2BAAgBG,MAAMM,IAAtB,EAA4BQ,MAA5B,EAAoCI,KAApC,CAA0C,IAA1C,EAAgDb,IAAhD;AACA,kBAAOR,gBAAgBG,MAAMM,IAAtB,CAAP;AACD;AACF;AACF,MAjBgB;AAAA,IAAjB;;AAmBAb,YAASO,MAAMG,IAAf,EAAqBH,KAArB,EAA4BC,IAA5B,EAAkCL,SAAlC,EACCuB,IADD,CACMf,SAAS,SAAT,CADN,EAC2BA,SAAS,QAAT,CAD3B;AAED,EA9BD;;AAgCA,KAAMgB,sBAAsB,SAAtBA,mBAAsB,CAACC,EAAD,EAAKC,YAAL,EAAsB;AAChD,UAAOA,aAAaC,OAAb,GACNJ,IADM,CACD,kBAAU;AACdvB,iBAAY,IAAIL,SAAJ,CAAc8B,EAAd,EAAkBG,MAAlB,CAAZ;;AAEA;AACA,SAAI,CAACA,OAAO7B,KAAR,IAAiB,CAAC6B,OAAOC,SAA7B,EAAwC;AACtC,cAAOnC,QAAQoC,OAAR,CAAgB,IAAhB,CAAP;AACD;;AAEDL,QAAGM,MAAH,CAAUC,KAAV,CAAgB,wCAAhB;;AAEA,YAAOjC,MAAMkC,MAAN,CAAaR,GAAGS,OAAH,CAAWC,IAAxB,EACNZ,IADM,CACD,eAAO;AACXa,aAAMA,IAAIC,OAAJ,CAAY,aAAZ,EAA2B,EAA3B,CAAN;AACArC,iBAAUsC,SAAV,CAAoB,EAAEC,UAAUH,GAAZ,EAApB;AACD,MAJM,EAKNb,IALM,CAKD;AAAA,cAAMG,aAAac,OAAb,CAAqBxC,UAAUyC,SAAV,EAArB,CAAN;AAAA,MALC,EAMNlB,IANM,CAMD;AAAA,cAAMvB,UAAU0C,cAAV,EAAN;AAAA,MANC,EAONnB,IAPM,CAOD;AAAA,cAAMvB,UAAU2C,OAAV,EAAN;AAAA,MAPC,EAQNpB,IARM,CAQD;AAAA,cAAME,GAAGmB,aAAH,CAAiBC,IAAjB,CAAsB;AAChCC,gBAAO,MADyB;AAEhCC,kBAAS;AAFuB,QAAtB,CAAN;AAAA,MARC,EAYNC,KAZM,CAYA,eAAO;AACZvB,UAAGM,MAAH,CAAUkB,KAAV,CAAgB,kCAAhB,EAAoDC,GAApD;AACAzB,UAAGmB,aAAH,CAAiBC,IAAjB,CAAsB;AACpBC,gBAAO,OADa;AAEpBC,kBAAS;AAFW,QAAtB;AAID,MAlBM,CAAP;AAmBD,IA9BM,CAAP;AA+BD,EAhCD;;AAkCAI,QAAOC,OAAP,GAAiB;;AAEfxB,WAAQ;AACNyB,oBAAe,EAAE9C,MAAM,QAAR,EAAkB+C,UAAU,IAA5B,EAAkCC,SAAS,EAA3C,EAA+CC,KAAK,kBAApD,EADT;AAENC,kBAAa,EAAElD,MAAM,QAAR,EAAkB+C,UAAU,IAA5B,EAAkCC,SAAS,EAA3C,EAA+CC,KAAK,wBAApD,EAFP;AAGNE,gBAAW,EAAEnD,MAAM,QAAR,EAAkB+C,UAAU,IAA5B,EAAkCC,SAAS,EAA3C,EAA+CC,KAAK,sBAApD,EAHL;AAING,kBAAa,EAAEpD,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS9D,KAAKmE,EAAL,EAA5C,EAJP;AAKNC,gBAAW,EAAEtD,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EALL;AAMN1B,gBAAW,EAAEtB,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EANL;AAONhB,eAAU,EAAEhC,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS,EAA5C,EAPJ;AAQNO,eAAU,EAAEvD,MAAM,QAAR,EARJ;AASNR,YAAO,EAAEQ,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EATD;AAUNQ,wBAAmB,EAAExD,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EAVb;AAWNS,sBAAiB,EAAEzD,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS,0BAA5C,EAXX;AAYNU,qBAAgB,EAAE1D,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,KAA1C,EAZV;AAaNW,0BAAqB,EAAE3D,MAAM,KAAR,EAAe+C,UAAU,KAAzB,EAAgCC,SAAS,EAAzC,EAA6CY,YAAY;AAAA,gBAAK3E,EAAE4E,OAAF,CAAUC,CAAV,CAAL;AAAA,QAAzD,EAbf;AAcNC,8BAAyB,EAAE/D,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,IAA1C,EAdnB;AAeNgB,qBAAgB,EAAEhE,MAAM,QAAR,EAAkB+C,UAAU,IAA5B,EAAkCC,SAAS,WAA3C,EAfV;AAgBNiB,+BAA0B,EAAEjE,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAhBpB;AAiBNmB,gCAA2B,EAAElE,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAjBrB;AAkBNoB,qBAAgB,EAAEnE,MAAM,KAAR,EAAe+C,UAAU,KAAzB,EAAgCC,SAAS,EAAzC,EAA6CY,YAAY;AAAA,gBAAK3E,EAAE4E,OAAF,CAAUC,CAAV,CAAL;AAAA,QAAzD,EAlBV;AAmBNM,4BAAuB,EAAEpE,MAAM,MAAR,EAAgB+C,UAAU,KAA1B,EAAiCC,SAAS,IAA1C,EAnBjB,EAmBmE;AACzEqB,mBAAc,EAAErE,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS,QAA5C,EApBR,EAoBoE;AAC1EsB,yBAAoB,EAAEtE,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS,YAA5C,EArBd;AAsBNuB,uBAAkB,EAAEvE,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS,eAA5C,EAtBZ;AAuBNwB,2BAAsB,EAAExE,MAAM,QAAR,EAAkB+C,UAAU,KAA5B,EAAmCC,SAAS,eAA5C;AAvBhB,IAFO;;AA4BfyB,SAAM,cAASvD,EAAT,EAAa;;AAEjBrC,kBAAaqC,EAAb,EAAiBwD,SAAjB;;AAEAxD,QAAGyD,WAAH,CAAeC,QAAf,CAAwB;AACtBC,aAAM,wBADgB;AAEtB7E,aAAM,UAFgB;AAGtB8E,cAAO,GAHe;AAItBC,gBAASnF,kBAJa;AAKtBgD,eAAQ,oBALc;AAMtBoC,oBAAa,0DACb;AAPsB,MAAxB;;AAUA9D,QAAGzB,SAAH,GAAe,EAAf;AACAR,OAAEgG,KAAF,CAAQ5F,OAAR,EAAiB,UAAC6F,MAAD,EAASL,IAAT,EAAkB;AACjC3D,UAAGzB,SAAH,CAAaoF,IAAb,IAAqBK,MAArB;AACA,WAAIC,WAAWN,KAAK/C,OAAL,CAAa,SAAb,EAAwB,MAAxB,CAAf;AACAZ,UAAGzB,SAAH,CAAa0F,QAAb,IAAyBhG,QAAQwB,MAAR,CAAe,YAAW;AACjD,aAAIyE,MAAMF,OAAOnE,KAAP,CAAa,IAAb,EAAmBsE,SAAnB,CAAV;AACAD,aAAIjF,IAAJ,GAAW,IAAImF,IAAJ,GAAWC,WAAX,KAA2BC,KAAKC,MAAL,EAAtC;AACA,aAAMC,WAAW,EAAE7F,OAAOuF,GAAT,EAAjB;;AAEA,aAAMO,UAAU,IAAIxG,OAAJ,CAAY,UAASoC,OAAT,EAAkBqE,MAAlB,EAA0B;AACpDF,oBAASnE,OAAT,GAAmBA,OAAnB;AACAmE,oBAASE,MAAT,GAAkBA,MAAlB;AACD,UAHe,CAAhB;;AAKAlG,yBAAgB0F,IAAIjF,IAApB,IAA4BuF,QAA5B;;AAEAxE,YAAGyD,WAAH,CAAekB,YAAf,CAA4BT,GAA5B;AACA,gBAAOO,OAAP;AACD,QAdwB,CAAzB;AAeD,MAlBD;AAmBD,IA9Dc;;AAgEfG,UAAO,eAAS5E,EAAT,EAAaG,MAAb,EAAqB;;AAE1BJ,yBAAoBC,EAApB,EAAwBG,MAAxB,EACCL,IADD,CACM,YAAM;AACVzB,gBAAS2B,EAAT,EAAazB,SAAb;;AAEAA,iBAAUsG,EAAV,CAAa,kBAAb,EAAiC,aAAK;AACpC7E,YAAG8E,MAAH,CAAUC,IAAV,CAAe,4BAAf,EAA6CC,CAA7C;AACD,QAFD;;AAIAzG,iBAAUsG,EAAV,CAAa,kBAAb,EAAiC,aAAK;AACpC7E,YAAG8E,MAAH,CAAUC,IAAV,CAAe,yBAAf,EAA0CC,CAA1C;AACD,QAFD;;AAIA,WAAMC,SAASjF,GAAGkF,SAAH,CAAa,oBAAb,CAAf;;AAEAD,cAAOE,GAAP,CAAW,SAAX,EAAsB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAClCA,aAAIjE,IAAJ,CAAS7C,UAAUyC,SAAV,EAAT;AACD,QAFD;;AAIAiE,cAAOK,IAAP,CAAY,SAAZ,EAAuB,UAACF,GAAD,EAAMC,GAAN,EAAc;AACnC9G,mBAAUsC,SAAV,CAAoBuE,IAAIG,IAAxB;AACApF,gBAAOY,OAAP,CAAexC,UAAUyC,SAAV,EAAf,EACClB,IADD,CACM;AAAA,kBAAMvB,UAAU0C,cAAV,EAAN;AAAA,UADN,EAECnB,IAFD,CAEM;AAAA,kBAAMuF,IAAIG,UAAJ,CAAe,GAAf,CAAN;AAAA,UAFN,EAGCjE,KAHD,CAGO,UAACE,GAAD,EAAS;AACd4D,eAAII,MAAJ,CAAW,GAAX,EAAgBrE,IAAhB,CAAqB,EAAEE,SAASG,IAAIH,OAAf,EAArB;AACD,UALD;AAMD,QARD;;AAUA2D,cAAOE,GAAP,CAAW,QAAX,EAAqB,UAACC,GAAD,EAAMC,GAAN,EAAc;AACjC/G,eAAMkC,MAAN,GACCV,IADD,CACM;AAAA,kBAAOuF,IAAIjE,IAAJ,CAAST,GAAT,CAAP;AAAA,UADN;AAED,QAHD;;AAKAsE,cAAOK,IAAP,CAAY,aAAZ,EAA2B,UAACF,GAAD,EAAMC,GAAN,EAAc;AACvC,aAAI9G,UAAUyC,SAAV,GAAsBZ,SAA1B,EAAqC;AACnC7B,qBAAUmH,UAAV,GACC5F,IADD,CACM;AAAA,oBAAMuF,IAAIG,UAAJ,CAAe,GAAf,CAAN;AAAA,YADN,EAECjE,KAFD,CAEO,UAACE,GAAD;AAAA,oBAAS4D,IAAII,MAAJ,CAAW,GAAX,EAAgBrE,IAAhB,CAAqB,EAAEE,SAASG,IAAIH,OAAf,EAArB,CAAT;AAAA,YAFP;AAGD,UAJD,MAIO;AACL/C,qBAAU2C,OAAV,GACCpB,IADD,CACM;AAAA,oBAAMuF,IAAIG,UAAJ,CAAe,GAAf,CAAN;AAAA,YADN,EAECjE,KAFD,CAEO,UAACE,GAAD;AAAA,oBAAS4D,IAAII,MAAJ,CAAW,GAAX,EAAgBrE,IAAhB,CAAqB,EAAEE,SAASG,IAAIH,OAAf,EAArB,CAAT;AAAA,YAFP;AAGD;AACF,QAVD;;AAYA2D,cAAOK,IAAP,CAAY,aAAZ,EAA2B,UAACF,GAAD,EAAMC,GAAN,EAAc;AACvC9G,mBAAUoH,qBAAV,GACC7F,IADD,CACM,UAAC8F,IAAD,EAAU;AACdP,eAAIjE,IAAJ,CAASwE,IAAT;AACD,UAHD,EAICrE,KAJD,CAIO,UAACE,GAAD,EAAS;AACd4D,eAAII,MAAJ,CAAW,GAAX,EAAgBrE,IAAhB,CAAqB,EAAEE,SAASG,IAAIH,OAAf,EAArB;AACD,UAND;AAOD,QARD;;AAUA2D,cAAOE,GAAP,CAAW,WAAX,EAAwB,UAACC,GAAD,EAAMC,GAAN,EAAc;AACpC,aAAMQ,cAAcC,KAAKC,KAAL,CAAWjI,GAAGkI,YAAH,CAAgBnI,KAAKoI,IAAL,CAAUzC,SAAV,EAAqB,iBAArB,CAAhB,CAAX,CAApB;AACA6B,aAAIjE,IAAJ,CAAS,EAAEiB,UAAUwD,YAAYxD,QAAxB,EAAT;AACD,QAHD;AAKD,MA5DD;AA8DD;AAhIc,EAAjB,C;;;;;;ACnFA,sD;;;;;;ACAA,kC;;;;;;ACAA,gC;;;;;;ACAA,oC;;;;;;ACAA,kC;;;;;;ACAA,sC;;;;;;;;;;;;;;;;;;ACAA;;;;;;;;AAQA,KAAMpE,UAAU,mBAAAL,CAAQ,CAAR,CAAhB;AACA,KAAMsI,eAAe,mBAAAtI,CAAQ,CAAR,CAArB;AACA,KAAMuI,SAAS,mBAAAvI,CAAQ,EAAR,CAAf;AACA,KAAMwI,QAAQ,mBAAAxI,CAAQ,EAAR,CAAd;AACA,KAAMG,IAAI,mBAAAH,CAAQ,CAAR,CAAV;AACA,KAAMyI,aAAa,mBAAAzI,CAAQ,EAAR,CAAnB;;AAEAwI,OAAM3B,OAAN,GAAgBxG,OAAhB;;AAEA,KAAMqI,kBAAkB,SAAlBA,eAAkB,CAASC,GAAT,EAAc;AACpC,UAAOA,IAAI3F,OAAJ,CAAY,gBAAZ,EAA8B,EAA9B,EAAkC4F,WAAlC,EAAP;AACD,EAFD;;KAIMtI,S;;;AACJ,sBAAY8B,EAAZ,EAAgBG,MAAhB,EAAwB;AAAA;;AAAA;;AAEtB,SAAI,CAACH,EAAD,IAAO,CAACG,MAAZ,EAAoB;AAClB,aAAM,IAAIsG,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,WAAK5F,SAAL,CAAeV,MAAf;;AAEA,WAAKuG,GAAL,GAAW1G,GAAGkF,SAAH,CAAa,oBAAb,EAAmC;AAC5C,0BAAmB,KADyB;AAE5C,eAAQ;AAAA,gBAAO,CAAC,aAAayB,IAAb,CAAkBvB,IAAIwB,WAAtB,CAAR;AAAA;AAFoC,MAAnC,CAAX;;AAKA,WAAKF,GAAL,CAASG,GAAT,CAAaR,WAAWT,IAAX,CAAgB;AAC3BkB,eAAQ,MAAKC,uBAAL,CAA6BC,IAA7B;AADmB,MAAhB,CAAb;;AAIA,WAAKC,YAAL;AAjBsB;AAkBvB;;;;+BAES9G,M,EAAQ;AAChB,YAAKA,MAAL,GAAc+G,OAAOC,MAAP,CAAc,EAAd,EAAkB,KAAKhH,MAAvB,EAA+BA,MAA/B,CAAd;AACD;;;iCAEW;AACV,cAAO,KAAKA,MAAZ;AACD;;;+BAES;AAAA;;AACR,cAAO,KAAKiH,gBAAL,GACNtH,IADM,CACD;AAAA,gBAAM,OAAKuH,cAAL,EAAN;AAAA,QADC,CAAP;AAED;;;kCAEY;AACX,cAAO,KAAKC,gBAAL,EAAP;AACD;;;qCAEeC,W,EAAaC,I,EAAMC,Y,EAAcC,O,EAAS;AACxD,WAAMpG,UAAU,EAAEkG,UAAF,EAAhB;AACA,WAAMG,wBAAwB,KAAKC,mBAAL,CAAyBH,YAAzB,CAA9B;AACA,WAAIE,yBAAyBA,sBAAsBE,MAAtB,GAA+B,CAA5D,EAA+D;AAC7DvG,iBAAQwG,aAAR,GAAwBH,qBAAxB;AACD;AACD,cAAO,KAAKI,WAAL,CAAiBR,WAAjB,EAA8BjG,OAA9B,EAAuCoG,OAAvC,CAAP;AACD;;;wCAEkBH,W,EAAaC,I,EAAMQ,O,EAASN,O,EAAS;AACtD,WAAMO,UAAU;AACdC,wBAAe,QADD;AAEdV;AAFc,QAAhB;AAIA,WAAMW,mBAAmB,KAAKC,cAAL,CAAoBJ,OAApB,CAAzB;AACAC,eAAQD,OAAR,GAAkBG,gBAAlB;AACA,cAAO,KAAKE,YAAL,CAAkBd,WAAlB,EAA+BU,OAA/B,EAAwCP,OAAxC,CAAP;AACD;;;yCAEmBH,W,EAAae,Q,EAAUZ,O,EAAS;AAClD,WAAMO,UAAU;AACdC,wBAAe,SADD;AAEdI;AAFc,QAAhB;AAIA,cAAO,KAAKD,YAAL,CAAkBd,WAAlB,EAA+BU,OAA/B,EAAwCP,OAAxC,CAAP;AACD;;;kCAEYH,W,EAAaU,O,EAASP,O,EAAS;AAC1C,WAAMpG,UAAU;AACdiH,qBAAY;AACVzJ,iBAAM,UADI;AAEVmJ;AAFU;AADE,QAAhB;AAMA,cAAO,KAAKF,WAAL,CAAiBR,WAAjB,EAA8BjG,OAA9B,EAAuCoG,OAAvC,CAAP;AACD;;;oCAEcH,W,EAAazI,I,EAAM6B,G,EAAK8G,Y,EAAcC,O,EAAS;AAC5D,WAAMpG,UAAU;AACdiH,qBAAY;AACVzJ,qBADU;AAEVmJ,oBAAS,EAAEtH,QAAF;AAFC;AADE,QAAhB;AAMA,WAAI+G,QAAQc,UAAR,IAAsBzK,EAAE0K,SAAF,CAAYf,QAAQc,UAApB,CAA1B,EAA2D;AACzDlH,iBAAQiH,UAAR,CAAmBN,OAAnB,CAA2BS,WAA3B,GAAyChB,QAAQc,UAAjD;AACD;AACD,WAAId,QAAQiB,YAAZ,EAA0B;AACxBrH,iBAAQiH,UAAR,CAAmBN,OAAnB,GAA6B;AAC3BW,0BAAelB,QAAQiB;AADI,UAA7B;AAGD;AACD,WAAMhB,wBAAwB,KAAKC,mBAAL,CAAyBH,YAAzB,CAA9B;AACA,WAAIE,yBAAyBA,sBAAsBE,MAAtB,GAA+B,CAA5D,EAA+D;AAC7DvG,iBAAQwG,aAAR,GAAwBH,qBAAxB;AACD;AACD,cAAO,KAAKI,WAAL,CAAiBR,WAAjB,EAA8BjG,OAA9B,EAAuCoG,OAAvC,CAAP;AACD;;;gCAEUH,W,EAAavD,M,EAAQ;AAC9B,cAAO,KAAK6E,WAAL,CAAiB;AACtBC,oBAAW;AACTC,eAAIxB;AADK,UADW;AAItByB,wBAAehF;AAJO,QAAjB,CAAP;AAMD;;;iCAEWuD,W,EAAajG,O,EAASoG,O,EAAS;AAAA;;AACzC,WAAMtC,MAAM,SAANA,GAAM;AAAA,gBAAM,OAAKyD,WAAL,CAAiB;AACjCC,sBAAW;AACTC,iBAAIxB;AADK,YADsB;AAIjCjG;AAJiC,UAAjB,CAAN;AAAA,QAAZ;;AAOA,WAAIoG,WAAWA,QAAQuB,MAAvB,EAA+B;AAC7B,aAAMC,cAAe5H,WAAWA,QAAQkG,IAApB,GAA4B,MAAMlG,QAAQkG,IAAR,CAAaK,MAAb,GAAsB,EAAxD,GAA6D,IAAjF;AACA,aAAMsB,UAAW,OAAOzB,QAAQuB,MAAf,KAA0B,QAA3B,GAAuCvB,QAAQuB,MAA/C,GAAwDC,WAAxE;AACA,gBAAO,KAAKE,mBAAL,CAAyB7B,WAAzB,EAAsC4B,OAAtC,EAA+CrJ,IAA/C,CAAoDsF,GAApD,CAAP;AACD;;AAED,cAAOA,KAAP;AACD;;;6CAEuB;AACtB,WAAMxD,gBAAgB,KAAKzB,MAAL,CAAYyB,aAAlC;AACA,WAAMI,cAAc,KAAK7B,MAAL,CAAY6B,WAAhC;;AAEA,cAAOoE,2CAAyCxE,aAAzC,4BAA+E;AACpFnC,iBAAQ,MAD4E;AAEpF4J,kBAAS,EAAC,gBAAgB,kBAAjB,EAF2E;AAGpF9D,eAAMO,KAAKwD,SAAL,CAAe;AACnBC,sBAAW3H,aADQ;AAEnB4H,mBAAQ,MAFW;AAGnBC,kBAAO,UAHY;AAInBC,0BAAe,EAAEC,SAAS/H,aAAX,EAJI;AAKnBgI,yBAAc5H;AALK,UAAf;AAH8E,QAA/E,EAWNlC,IAXM,CAWD,KAAK+J,uBAXJ,EAYN/J,IAZM,CAYD;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAZC,CAAP;AAaD;;;iCAEWL,I,EAAMuE,Q,EAAUrK,M,EAAQ;AAAA;;AAClCqK,kBAAWA,YAAY,UAAvB;AACArK,gBAASA,UAAU,MAAnB;;AAEA,WAAMkB,8CAA4CmJ,QAAlD;AACA,cAAO1D,MAASzF,GAAT,sBAA6B,KAAKR,MAAL,CAAY6B,WAAzC,EAAwD;AAC7DvC,uBAD6D;AAE7D4J,kBAAS,EAAE,gBAAgB,kBAAlB,EAFoD;AAG7D9D,eAAMO,KAAKwD,SAAL,CAAe/D,IAAf;AAHuD,QAAxD,EAKNzF,IALM,CAKD,KAAK+J,uBALJ,EAMN/J,IANM,CAMD;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QANC,EAON9F,IAPM,CAOD,gBAAQ;AACZ,gBAAKiK,YAAL,CAAkB,kBAAlB,EAAsC,EAAEpJ,QAAF,EAAOqJ,OAAO,OAAK7J,MAAL,CAAY6B,WAA1B,EAAuCuD,UAAvC,EAA6CuE,kBAA7C,EAAuDrK,cAAvD,EAA+DwK,UAAUrE,IAAzE,EAAtC;AACA,gBAAOA,IAAP;AACD,QAVM,CAAP;AAWD;;;uCAEiBL,I,EAAM9F,M,EAAQ;AAC9B,cAAO,KAAKoJ,WAAL,CAAiBtD,IAAjB,EAAuB,iBAAvB,EAA0C9F,MAA1C,CAAP;AACD;;;yCAEmB8H,W,EAAa2C,Y,EAAc;AAAA;;AAC7C,WAAIf,UAAU,CAACe,YAAD,IAAiBC,MAAMD,YAAN,CAAjB,GAAuC,CAAvC,GAA2CA,YAAzD;AACAf,iBAAU7E,KAAK8F,GAAL,CAAS,KAAT,EAAgBjB,OAAhB,CAAV;;AAEA,WAAIe,iBAAiB,IAArB,EAA2B;AACzBf,mBAAU,IAAV;AACD;;AAED,WAAMkB,SAASlB,UAAU,CAAV,GACXlL,QAAQoC,OAAR,CAAgB,KAAKiK,UAAL,CAAgB/C,WAAhB,EAA6B,WAA7B,CAAhB,CADW,GAEXtJ,QAAQoC,OAAR,CAAgB,IAAhB,CAFJ;;AAIA,cAAOgK,OACNE,KADM,CACApB,OADA,EAENrJ,IAFM,CAED;AAAA,gBAAM,OAAKwK,UAAL,CAAgB/C,WAAhB,EAA6B,YAA7B,CAAN;AAAA,QAFC,CAAP;AAGD;;;oCAEciD,M,EAAQ;AACrB,WAAM7J,2CAAyC6J,MAAzC,qFAA+H,KAAKrK,MAAL,CAAY6B,WAAjJ;AACA,cAAOoE,MAAMzF,GAAN,EACJb,IADI,CACC,KAAK+J,uBADN,EAEJ/J,IAFI,CAEC;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAFD,EAGJrE,KAHI,CAGE;AAAA,gBAAOkJ,QAAQC,GAAR,kCAA2CjJ,GAA3C,CAAP;AAAA,QAHF,CAAP;AAID;;;mDAE6B;AAC5B,WAAIkJ,UAAU,EAAEC,iBAAiB,EAAnB,EAAd;;AAEA,eAAO,KAAKzK,MAAL,CAAY2C,cAAnB;AACE,cAAK,WAAL;AACE6H,mBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,KAAxC;AACA;AACF,cAAK,YAAL;AACE,eAAIC,qBAAqB,KAAK3K,MAAL,CAAY4C,wBAAZ,CAAqC3D,KAArC,CAA2C,OAA3C,CAAzB;AACAuL,mBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,QAAxC;AACAF,mBAAQC,eAAR,CAAwBG,SAAxB,GAAoC;AAClCC,wBAAWF;AADuB,YAApC;AAGA;AACF,cAAK,aAAL;AACEH,mBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,QAAxC;AACA,eAAII,qBAAqB,KAAK9K,MAAL,CAAY6C,yBAAZ,CAAsC5D,KAAtC,CAA4C,OAA5C,CAAzB;AACAuL,mBAAQC,eAAR,CAAwBG,SAAxB,GAAoC;AAClCG,wBAAWD;AADuB,YAApC;AAGA;AACF,cAAK,YAAL;AACEN,mBAAQC,eAAR,CAAwBC,aAAxB,GAAwC,MAAxC;AACA;AApBJ;;AAuBA,cAAOF,OAAP;AACD;;;yCAEmB;AAClB,WAAMhK,6EAA2E,KAAKR,MAAL,CAAY6B,WAA7F;AACA,WAAI2I,UAAU,KAAKQ,2BAAL,EAAd;;AAEA,cAAO,KAAKtC,WAAL,CAAiB8B,OAAjB,EAA0B,mBAA1B,EAA+C,MAA/C,CAAP;AACD;;;2CAEqBS,O,EAAS;AAC7B,WAAMzK,sGAAoG,KAAKR,MAAL,CAAY6B,WAAtH;AACA,cAAOoE,MAAMzF,GAAN,EACJb,IADI,CACC,KAAK+J,uBADN,EAEJ/J,IAFI,CAEC;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAFD,EAGJ9F,IAHI,CAGC,UAAC8F,IAAD,EAAU;AACd,aAAIA,QAAQA,KAAKyF,IAAb,IAAqBzF,KAAKyF,IAAL,CAAU,CAAV,CAAzB,EAAuC;AACrC,kBAAOzF,KAAKyF,IAAL,CAAU,CAAV,EAAaC,mBAApB;AACD,UAFD,MAEO;AACL,kBAAO,EAAP;AACD;AACF,QATI,EAUJxL,IAVI,CAUC,UAACyL,UAAD,EAAgB;AACpB,aAAI,CAACA,UAAD,IAAe,CAACA,WAAW1D,MAA/B,EAAuC;AACrC;AACD;;AAEDzB,eAAMzF,GAAN,EAAW;AACTlB,mBAAQ,MADC;AAET4J,oBAAS,EAAE,gBAAgB,kBAAlB,EAFA;AAGT9D,iBAAMO,KAAKwD,SAAL,CAAe;AACnBkC,2BAAc,qBADK;AAEnBF,kCAAqBC,UAFF;AAGnBE,iCAAoB;AAHD,YAAf;AAHG,UAAX;AASD,QAxBI,EAyBJ3L,IAzBI,CAyBC,KAAK+J,uBAzBN,EA0BJ/J,IA1BI,CA0BC;AAAA,gBAAMsG,MAAMzF,GAAN,EAAW;AACrBlB,mBAAQ,MADa;AAErB4J,oBAAS,EAAE,gBAAgB,kBAAlB,EAFY;AAGrB9D,iBAAMO,KAAKwD,SAAL,CAAe;AACnBkC,2BAAc,qBADK;AAEnBF,kCAAqBF,OAFF;AAGnBK,iCAAoB;AAHD,YAAf;AAHe,UAAX,CAAN;AAAA,QA1BD,EAmCJ3L,IAnCI,CAmCC,KAAK+J,uBAnCN,CAAP;AAoCD;;;qCAEerC,I,EAAM;AACpB,cAAO,KAAKkE,iBAAL,CAAuB;AAC5BF,uBAAc,UADc;AAE5BG,mBAAU,EAAEnE,UAAF;AAFkB,QAAvB,CAAP;AAID;;;0CAEoB;AACnB,cAAO,KAAKkE,iBAAL,CAAuB;AAC5BF,uBAAc;AADc,QAAvB,EAEJ,QAFI,CAAP;AAGD;;;yCAEmBxH,M,EAAQ;AAC1B,WAAMiE,UAAW,OAAOjE,MAAP,KAAkB,QAAnB,GAA+BA,MAA/B,GAAwC,aAAxD;AACA,WAAI,OAAOA,MAAP,KAAkB,UAAtB,EAAkC;AAChC,cAAKa,EAAL,eAAoBoD,OAApB,EAA+BjE,MAA/B;AACD;AACD,cAAO,KAAK0H,iBAAL,CAAuB;AAC5BF,uBAAc,iBADc;AAE5BI,uBAAc,YAFc;AAG5BC,0BAAiB,CAAE,EAAE5D,gBAAF,EAAF;AAHW,QAAvB,CAAP;AAKD;;;8CAEwB;AACvB,cAAO,KAAKyD,iBAAL,CAAuB;AAC5BF,uBAAc,iBADc;AAE5BI,uBAAc;AAFc,QAAvB,EAGJ,QAHI,CAAP;AAID;;;uCAEiB5D,O,EAAS;AACzB,WAAMG,mBAAmB,KAAKC,cAAL,CAAoBJ,OAApB,CAAzB;AACA,cAAO,KAAK0D,iBAAL,CAAuB;AAC5BF,uBAAc,iBADc;AAE5BI,uBAAc,iBAFc;AAG5BC,0BAAiB1D;AAHW,QAAvB,CAAP;AAKD;;;4CAEsB;AACrB,cAAO,KAAKuD,iBAAL,CAAuB;AAC5BF,uBAAc,iBADc;AAE5BI,uBAAc;AAFc,QAAvB,EAGJ,QAHI,CAAP;AAID;;;sCAEgB;AAAA;;AACf,WAAME,mBAAmB,SAAnBA,gBAAmB;AAAA,gBAAM,OAAK3L,MAAL,CAAYmC,iBAAZ,GAC3B,OAAKyJ,mBAAL,EAD2B,GAE3B,OAAKC,sBAAL,EAFqB;AAAA,QAAzB;;AAIA,WAAMC,qBAAqB,SAArBA,kBAAqB;AAAA,gBAAMlO,EAAEmO,OAAF,CAAU,OAAK/L,MAAL,CAAYoC,eAAtB,IAC7B,OAAK4J,kBAAL,EAD6B,GAE7B,OAAKC,eAAL,CAAqB,OAAKjM,MAAL,CAAYoC,eAAjC,CAFuB;AAAA,QAA3B;;AAIA,WAAM8J,QAAQ,KAAKC,4BAAL,CAAkC,KAAKnM,MAAL,CAAYsC,mBAA9C,CAAd;AACA,WAAM8J,uBAAuB,SAAvBA,oBAAuB;AAAA,gBAAM,OAAKpM,MAAL,CAAYqC,cAAZ,GAC/B,OAAKgK,iBAAL,CAAuBH,KAAvB,CAD+B,GAE/B,OAAKI,oBAAL,EAFyB;AAAA,QAA7B;;AAIA,WAAMC,uBAAuB,SAAvBA,oBAAuB;AAAA,gBAAM,OAAKC,iBAAL,EAAN;AAAA,QAA7B;;AAEA,WAAMC,uBAAuB,SAAvBA,oBAAuB;AAAA,gBAAM,OAAKC,qBAAL,CAA2B,OAAK1M,MAAL,CAAY8C,cAAvC,CAAN;AAAA,QAA7B;;AAEA,WAAI6J,SAAS,KAAb;AACA,WAAMC,kBAAkB,SAAlBA,eAAkB,CAACC,OAAD;AAAA,gBAAa,UAACvL,GAAD,EAAS;AAC5C,eAAIqL,MAAJ,EAAY,MAAMrL,GAAN;AACZ,eAAMH,6BAA2B0L,OAA3B,UAAuCvL,IAAIH,OAAjD;AACAwL,oBAAS,IAAT;AACA,iBAAM,IAAIrG,KAAJ,CAAUnF,OAAV,CAAN;AACD,UALuB;AAAA,QAAxB;;AAOA,cAAOwK,mBACNvK,KADM,CACAwL,gBAAgB,aAAhB,CADA,EAENjN,IAFM,CAEDmM,kBAFC,EAGN1K,KAHM,CAGAwL,gBAAgB,eAAhB,CAHA,EAINjN,IAJM,CAIDyM,oBAJC,EAKNhL,KALM,CAKAwL,gBAAgB,iBAAhB,CALA,EAMNjN,IANM,CAMD4M,oBANC,EAONnL,KAPM,CAOAwL,gBAAgB,iBAAhB,CAPA,EAQNjN,IARM,CAQD8M,oBARC,EASNrL,KATM,CASAwL,gBAAgB,iBAAhB,CATA,CAAP;AAUD;;;4BAEME,O,EAAS;AACd,cAAOA,QAAQpN,KAAR,CAAc,IAAd,EAAoB,CAAE,IAAF,CAApB,CAAP;AACD;;;oCAEcmI,O,EAAS;AACtB,cAAOA,WAAWA,QAAQkF,GAAR,CAAY,UAACC,MAAD,EAAY;AACxC,aAAI,OAAOA,MAAP,KAAkB,QAAtB,EAAgC;AAC9B,kBAAO;AACLrO,mBAAM,UADD;AAELsO,oBAAOD,MAFF;AAGLlF,sBAAS,YAAY3B,gBAAgB6G,MAAhB;AAHhB,YAAP;AAKD,UAND,MAMO,IAAIA,UAAUA,OAAOC,KAArB,EAA4B;AACjC,kBAAOD,MAAP;AACD;AACD,gBAAO,EAAP;AACD,QAXiB,CAAlB;AAYD;;;yCAEmB1F,Y,EAAc;AAChC,cAAOA,gBAAgBA,aAAayF,GAAb,CAAiB,UAACG,KAAD,EAAW;AACjD,aAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;AAC7B,kBAAO;AACLC,2BAAc,MADT;AAELF,oBAAOC,KAFF;AAGLpF,sBAAS,QAAQ3B,gBAAgB+G,KAAhB;AAHZ,YAAP;AAKD,UAND,MAMO,IAAIA,SAASA,MAAMD,KAAnB,EAA0B;AAC/B,kBAAO;AACLE,2BAAcD,MAAMC,YAAN,IAAsB,MAD/B;AAELF,oBAAOC,MAAMD,KAFR;AAGLnF,sBAASoF,MAAMpF,OAAN,IAAiB,QAAQ3B,gBAAgB+G,MAAMD,KAAtB,CAH7B;AAILG,wBAAWF,MAAME;AAJZ,YAAP;AAMD;AACD,gBAAO,EAAP;AACD,QAhBsB,CAAvB;AAiBD;;;kCAEYzO,I,EAAMH,K,EAAO;AACxB,YAAKoG,IAAL,CAAUjG,IAAV,EAAgBH,KAAhB;AACD;;;yCAEmBA,K,EAAO;AACzB,WAAM6I,OAAO7I,MAAM2C,OAAN,CAAckG,IAA3B;AACA,WAAI,CAACA,IAAL,EAAW;AAAE;AAAQ;;AAErB,YAAKuC,YAAL,CAAkB,SAAlB,EAA6BpL,KAA7B;;AAEA,WAAIA,MAAM2C,OAAN,IAAiB,KAAKnB,MAAL,CAAY0C,uBAAjC,EAA0D;AACxD,cAAKyH,UAAL,CAAgB3L,MAAM6O,MAAN,CAAazE,EAA7B,EAAiC,WAAjC;AACD;AACF;;;4CAEsBpK,K,EAAO;AAC5B,YAAKoL,YAAL,CAAkB,YAAlB,EAAgCpL,KAAhC;;AAEA,WAAIA,MAAM2C,OAAN,IAAiB,KAAKnB,MAAL,CAAY0C,uBAAjC,EAA0D;AACxD,cAAKyH,UAAL,CAAgB3L,MAAM6O,MAAN,CAAazE,EAA7B,EAAiC,WAAjC;AACD;AACF;;;0CAEoBpK,K,EAAO;AAC1B,WAAMsJ,UAAUtJ,MAAM8O,QAAN,CAAexF,OAA/B;AACA,WAAIA,OAAJ,EAAa;AACX,cAAK8B,YAAL,eAA8B9B,OAA9B,EAAyCtJ,KAAzC;AACD;AACD,YAAKoL,YAAL,CAAkB,UAAlB,EAA8BpL,KAA9B;AACD;;;4CAEsBA,K,EAAO;AAC5B,WAAMsJ,UAAUtJ,MAAM2C,OAAN,CAAcoM,WAAd,IAA6B/O,MAAM2C,OAAN,CAAcoM,WAAd,CAA0BzF,OAAvE;AACA,WAAIA,OAAJ,EAAa;AACX,cAAK8B,YAAL,kBAAiC9B,OAAjC,EAA4CtJ,KAA5C;AACD;AACD,YAAKoL,YAAL,CAAkB,aAAlB,EAAiCpL,KAAjC;;AAEA,WAAIA,MAAM2C,OAAN,IAAiB,KAAKnB,MAAL,CAAY0C,uBAAjC,EAA0D;AACxD,cAAKyH,UAAL,CAAgB3L,MAAM6O,MAAN,CAAazE,EAA7B,EAAiC,WAAjC;AACD;AACF;;;6CAEuB1D,G,EAAK;AAC3B,WAAI,CAACA,GAAL,EAAU;;AAEV,WAAIA,IAAII,MAAJ,GAAa,GAAjB,EAAsB;AACpB,gBAAOJ,GAAP;AACD;;AAED,WAAIsI,eAAe,6CAAnB;AACAA,uBAAgB,eAAetI,IAAII,MAAnB,GAA4B,IAA5B,GAAmCJ,IAAIuI,UAAvC,GAAoD,GAApE;;AAEA,cAAO3P,QAAQoC,OAAR,CAAgB,IAAhB,EACNP,IADM,CACD;AAAA,gBAAMuF,IAAIO,IAAJ,EAAN;AAAA,QADC,EAEN9F,IAFM,CAED,gBAAQ;AACZ6N,yBAAgB,OAAO/H,KAAKpE,KAAL,CAAWF,OAAlC;AACD,QAJM,EAKNuM,OALM,CAKE,YAAM;AACb,eAAM,IAAIpH,KAAJ,CAAUkH,YAAV,CAAN;AACD,QAPM,CAAP;AAQD;;;oCAEc;AAAA;;AACb,YAAKjH,GAAL,CAASvB,GAAT,CAAa,UAAb,EAAyB,UAACC,GAAD,EAAMC,GAAN,EAAc;AACrC,aAAID,IAAI0I,KAAJ,CAAU,UAAV,MAA0B,WAA1B,IAAyC1I,IAAI0I,KAAJ,CAAU,kBAAV,MAAkC,OAAK3N,MAAL,CAAY+B,WAA3F,EAAwG;;AAEtGmD,eAAII,MAAJ,CAAW,GAAX,EAAgBrE,IAAhB,CAAqBgE,IAAI0I,KAAJ,CAAU,eAAV,CAArB;AACD,UAHD,MAGO;AACLrD,mBAAQjJ,KAAR,CAAc,2DAAd;AACA6D,eAAIG,UAAJ,CAAe,GAAf;AACD;AACF,QARD;;AAUA,YAAKkB,GAAL,CAASpB,IAAT,CAAc,UAAd,EAA0B,UAACF,GAAD,EAAMC,GAAN,EAAc;AACtC,aAAIgG,OAAOjG,IAAIG,IAAf;AACA,aAAI8F,KAAK7B,MAAL,KAAgB,MAApB,EAA4B;AAC1B;AACD;;AAED,gBAAKO,YAAL,CAAkB,kBAAlB,EAAsCsB,IAAtC;;AAEA;AACAA,cAAK0C,KAAL,CAAWC,OAAX,CAAmB,UAACD,KAAD,EAAW;AAC5B,eAAIA,SAAS,CAACA,MAAME,SAApB,EAA+B;AAC7B;AACD;AACD;AACAF,iBAAME,SAAN,CAAgBD,OAAhB,CAAwB,UAACrP,KAAD,EAAW;AACjC,iBAAIA,MAAM2C,OAAN,IAAiB3C,MAAM2C,OAAN,CAAc4M,OAA/B,IAA0C,CAAC,OAAK/N,MAAL,CAAYgO,eAA3D,EAA4E;AAC1E;AACD;AACD,iBAAIxP,MAAM2C,OAAN,IAAiB3C,MAAM2C,OAAN,CAAckG,IAAnC,EAAyC;AACvC,mBAAI7I,MAAM2C,OAAN,CAAcoM,WAAlB,EAA+B;AAC7B,wBAAKU,sBAAL,CAA4BzP,KAA5B;AACD,gBAFD,MAEO;AACL,wBAAK0P,mBAAL,CAAyB1P,KAAzB;AACD;AACF,cAND,MAMO,IAAIA,MAAM2C,OAAN,IAAiB3C,MAAM2C,OAAN,CAAcgN,WAAnC,EAAgD;AACrD,sBAAKC,sBAAL,CAA4B5P,KAA5B;AACD,cAFM,MAEA,IAAIA,MAAM8O,QAAV,EAAoB;AACzB,sBAAKe,oBAAL,CAA0B7P,KAA1B;AACD,cAFM,MAEA,IAAIA,MAAM8P,QAAV,EAAoB;AACzB,sBAAK1E,YAAL,CAAkB,UAAlB,EAA8BpL,KAA9B;AACD,cAFM,MAEA,IAAIA,MAAM+P,IAAV,EAAgB;AACrB,sBAAK3E,YAAL,CAAkB,MAAlB,EAA0BpL,KAA1B;AACD,cAFM,MAEA,IAAIA,MAAMgQ,eAAV,EAA2B;AAChC,sBAAK5E,YAAL,CAAkB,iBAAlB,EAAqCpL,KAArC;AACD,cAFM,MAEA,IAAIA,MAAMiQ,KAAV,EAAiB;AACtB,sBAAK7E,YAAL,CAAkB,OAAlB,EAA2BpL,KAA3B;AACD,cAFM,MAEA,IAAIA,MAAMkQ,QAAV,EAAoB;AACzB,sBAAK9E,YAAL,CAAkB,UAAlB,EAA8BpL,KAA9B;AACD,cAFM,MAEA,IAAIA,MAAMmQ,OAAV,EAAkB;AACvB,sBAAK/E,YAAL,CAAkB,SAAlB,EAA6BpL,KAA7B;AACD,cAFM,MAGF;AACH8L,uBAAQC,GAAR,CAAY,kCAAZ,EAAgD/L,KAAhD;AACD;AACF,YA9BD;AA+BD,UApCD;;AAsCA;AACA0G,aAAIG,UAAJ,CAAe,GAAf;AACD,QAjDD;AAkDD;;;6CAEuBJ,G,EAAKC,G,EAAK0J,G,EAAK;AACrC,WAAI,CAAC,cAAcpI,IAAd,CAAmBvB,IAAIvH,IAAvB,CAAL,EAAmC;AACjC;AACD;;AAED,WAAImR,YAAY5J,IAAIiE,OAAJ,CAAY,iBAAZ,CAAhB;AACA,WAAI,CAAC2F,SAAL,EAAgB;AACd,eAAM,IAAIvI,KAAJ,CAAU,2CAAV,CAAN;AACD,QAFD,MAEO;AAAA,gCACUuI,UAAU5P,KAAV,CAAgB,GAAhB,CADV;AAAA;AAAA,aACE6P,IADF;;AAEL,aAAIC,eAAe/I,OAAOgJ,UAAP,CAAkB,MAAlB,EAA0B,KAAKhP,MAAL,CAAY8B,SAAtC,EAAiDmN,MAAjD,CAAwDL,GAAxD,EAA6DM,MAA7D,CAAoE,KAApE,CAAnB;;AAEA,aAAIJ,QAAQC,YAAZ,EAA0B;AACxB,iBAAM,IAAIzI,KAAJ,CAAU,2CAAV,CAAN;AACD;AACF;AACF;;;oDAE8B;AAC7B,WAAI,KAAKtG,MAAL,CAAYqC,cAAZ,IAA8B,KAAKrC,MAAL,CAAYsC,mBAA9C,EAAmE;AACjE,gBAAO,KAAKtC,MAAL,CAAYsC,mBAAZ,CAAgCyK,GAAhC,CAAoC,UAACoC,IAAD,EAAU;;AAEnD,eAAIA,KAAKC,KAAL,IAAcD,KAAKxQ,IAAL,KAAc,UAAhC,EAA4C;AAC1CwQ,kBAAKrH,OAAL,GAAeqH,KAAKC,KAApB;AACA,oBAAOD,KAAKC,KAAZ;AACD,YAHD,MAGO,IAAID,KAAKC,KAAL,IAAcD,KAAKxQ,IAAL,KAAc,KAAhC,EAAuC;AAC5CwQ,kBAAK3O,GAAL,GAAW2O,KAAKC,KAAhB;AACAD,kBAAKxQ,IAAL,GAAY,SAAZ;AACA,oBAAOwQ,KAAKC,KAAZ;AACD;AACD,kBAAOD,IAAP;AACD,UAXM,CAAP;AAYD;AACF;;;wCAEkB;AAAA;;AACjB,WAAME,WAAW,uDACf,aADe,GACC,KAAKrP,MAAL,CAAYyB,aADb,GAEf,iBAFe,GAEK,KAAKzB,MAAL,CAAY8B,SAFjB,GAGf,gCAHF;;AAKA,WAAMtB,2CAAyC,KAAKR,MAAL,CAAYyB,aAArD,iCAAN;;AAEA,cAAOwE,MAAMoJ,QAAN,EACN1P,IADM,CACD,KAAK+J,uBADJ,EAEN/J,IAFM,CAED;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAFC,EAGN9F,IAHM,CAGD;AAAA,gBAAQ8F,KAAKgE,YAAb;AAAA,QAHC,EAIN9J,IAJM,CAID;AAAA,gBAASsG,MAAMzF,MAAMqJ,KAAZ,EAAmB;AAChCvK,mBAAQ,MADwB;AAEhC4J,oBAAS,EAAC,gBAAgB,kBAAjB,EAFuB;AAGhC9D,iBAAMO,KAAKwD,SAAL,CAAe;AACnBE,qBAAQ,MADW;AAEnBiG,2BAAc,aAAa,OAAKtP,MAAL,CAAYW,QAAzB,GAAoC,iCAF/B;AAGnB4O,2BAAc,OAAKvP,MAAL,CAAY+B,WAHP;AAInByN,qBAAQ,CACN,oBADM,EAEN,eAFM,EAGN,UAHM,EAIN,kBAJM,EAKN,qBALM,EAMN,qBANM;AAJW,YAAf;AAH0B,UAAnB,CAAT;AAAA,QAJC,EAqBN7P,IArBM,CAqBD,KAAK+J,uBArBJ,EAsBN/J,IAtBM,CAsBD;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAtBC,CAAP;AAuBD;;;sCAEgB;AACf,WAAMjF,MAAM,qEAAqE,KAAKR,MAAL,CAAY6B,WAA7F;;AAEA,cAAOoE,MAAMzF,GAAN,EAAW,EAAElB,QAAQ,MAAV,EAAX,EACNK,IADM,CACD,KAAK+J,uBADJ,EAEN/J,IAFM,CAED;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAFC,EAGNrE,KAHM,CAGA;AAAA,gBAAOkJ,QAAQC,GAAR,CAAYjJ,GAAZ,CAAP;AAAA,QAHA,CAAP;AAID;;;wCAEkB;AACjB,WAAMd,MAAM,qEAAqE,KAAKR,MAAL,CAAY6B,WAA7F;;AAEA,cAAOoE,MAAMzF,GAAN,EAAW,EAAElB,QAAQ,QAAV,EAAX,EACNK,IADM,CACD,KAAK+J,uBADJ,EAEN/J,IAFM,CAED;AAAA,gBAAOuF,IAAIO,IAAJ,EAAP;AAAA,QAFC,EAGNrE,KAHM,CAGA;AAAA,gBAAOkJ,QAAQC,GAAR,CAAYjJ,GAAZ,CAAP;AAAA,QAHA,CAAP;AAID;;;;GAxlBqByE,Y;;AA4lBxBxE,QAAOC,OAAP,GAAiBzD,SAAjB,C;;;;;;ACjnBA,2C;;;;;;ACAA,oC;;;;;;ACAA,wC;;;;;;ACAA,yC;;;;;;ACAA;;AAEA,KAAMH,IAAI,mBAAAH,CAAQ,CAAR,CAAV;;AAEA,KAAMgS,iBAAiB,SAAjBA,cAAiB,CAACpF,MAAD,EAAY;AACjC,OAAI,CAAC,SAAS7D,IAAT,CAAc6D,MAAd,CAAL,EAA4B;AAC1B,WAAM,IAAI/D,KAAJ,CAAU,gBAAV,CAAN;AACD;AACF,EAJD;;AAMA,KAAMoJ,eAAe,SAAfA,YAAe,CAACrI,IAAD,EAAU;AAC7B,OAAI,OAAOA,IAAP,KAAiB,QAAjB,IAA6BA,KAAKK,MAAL,GAAc,GAA/C,EAAoD;AAClD,WAAM,IAAIpB,KAAJ,CAAU,4CAAV,CAAN;AACD;AACF,EAJD;;AAMA,KAAMqJ,uBAAuB,SAAvBA,oBAAuB,CAAChI,aAAD,EAAmB;AAC9C,OAAI,CAAC/J,EAAE4E,OAAF,CAAUmF,aAAV,CAAL,EAA+B;AAC7B,WAAM,IAAIrB,KAAJ,CAAU,gCAAV,CAAN;AACD;;AAED1I,KAAEiQ,OAAF,CAAUlG,aAAV,EAAyBiI,kBAAzB;AACD,EAND;;AAQA,KAAMA,qBAAqB,SAArBA,kBAAqB,CAACrC,WAAD,EAAiB;AAC1C,OAAI,OAAOA,WAAP,KAAwB,QAA5B,EAAsC;AACpC,SAAI,CAACA,WAAD,IAAgB,OAAOA,YAAYN,KAAnB,KAA8B,QAAlD,EAA4D;AAC1D,aAAM,IAAI3G,KAAJ,CAAU,qDACd,eADI,CAAN;AAED;AACF;AACF,EAPD;;AASA,KAAMuJ,iBAAiB,SAAjBA,cAAiB,CAAC/G,MAAD,EAAY;AACjC,OAAI,CAAClL,EAAE0K,SAAF,CAAYQ,MAAZ,CAAD,IAAwB,CAAClL,EAAEkS,QAAF,CAAWhH,MAAX,CAA7B,EAAiD;AAC/C,WAAM,IAAIxC,KAAJ,CAAU,6CAAV,CAAN;AACD;AACF,EAJD;;AAMA,KAAMyJ,yBAAyB,SAAzBA,sBAAyB,CAACpR,IAAD,EAAU;AACvC,OAAI,OAAOA,IAAP,KAAiB,QAArB,EAA+B;AAC7B,WAAM,IAAI2H,KAAJ,CAAU,uCAAV,CAAN;AACD;;AAED,OAAI,CAAC1I,EAAEoS,QAAF,CAAW,CAAC,OAAD,EAAU,OAAV,EAAmB,OAAnB,EAA4B,MAA5B,CAAX,EAAgDrR,KAAKsR,WAAL,EAAhD,CAAL,EAA0E;AACxE,WAAM,IAAI3J,KAAJ,CAAU,yBAAV,CAAN;AACD;AACF,EARD;;AAUA,KAAM4J,cAAc,SAAdA,WAAc,CAAC1P,GAAD,EAAS;AAC3B,OAAI,OAAOA,GAAP,KAAgB,QAApB,EAA8B;AAC5B,WAAM,IAAI8F,KAAJ,CAAU,6BAAV,CAAN;AACD;AACF,EAJD;;AAMA,KAAM6J,0BAA0B,SAA1BA,uBAA0B,CAACrI,OAAD,EAAa;AAC3C,OAAI,CAAClK,EAAEwS,aAAF,CAAgBtI,OAAhB,CAAL,EAA+B;AAC7B,WAAM,IAAIxB,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,OAAI,OAAOwB,QAAQC,aAAf,KAAkC,QAAtC,EAAgD;AAC9C,WAAM,IAAIzB,KAAJ,CAAU,6BAAV,CAAN;AACD;AACF,EARD;;AAUA,KAAM+J,yBAAyB,SAAzBA,sBAAyB,CAAClI,QAAD,EAAc;AAC3C,OAAI,CAACvK,EAAE4E,OAAF,CAAU2F,QAAV,CAAL,EAA0B;AACxB,WAAM,IAAI7B,KAAJ,CAAU,kCAAV,CAAN;AACD;;AAED1I,KAAEiQ,OAAF,CAAU1F,QAAV,EAAoB,UAACmI,OAAD,EAAa;AAC/B,SAAI,CAAC1S,EAAEwS,aAAF,CAAgBE,OAAhB,CAAL,EAA+B;AAC7B,aAAM,IAAIhK,KAAJ,CAAU,uCAAV,CAAN;AACD;AACF,IAJD;AAKD,EAVD;;AAYA,KAAMiK,aAAa,SAAbA,UAAa,CAAClG,MAAD,EAAShD,IAAT,EAAeE,OAAf,EAA2B;AAC5CkI,kBAAepF,MAAf;AACAqF,gBAAarI,IAAb;;AAEA,OAAIE,WAAWA,QAAQI,aAAvB,EAAsC;AACpCgI,0BAAqBpI,QAAQI,aAA7B;AACD;;AAED,OAAIJ,WAAWA,QAAQuB,MAAvB,EAA+B;AAC7B+G,oBAAetI,QAAQuB,MAAvB;AACD;;AAED,UAAO;AACLpK,eAAU,UADL;AAELC,WAAM,MAFD;AAGL0I,WAAMA,IAHD;AAIL9H,UAAK;AACHiR,WAAInG,MADD;AAEHlJ,gBAASkG,IAFN;AAGHyB,eAASvB,WAAWA,QAAQuB,MAHzB;AAIHnB,sBAAeJ,WAAWA,QAAQI,aAJ/B;AAKHlI,iBAAU8H,WAAWA,QAAQ9H,QAL1B;AAMHD,qBAAc+H,WAAWA,QAAQ/H;AAN9B;AAJA,IAAP;AAaD,EAzBD;;AA2BA,KAAMiR,mBAAmB,SAAnBA,gBAAmB,CAACpG,MAAD,EAAS1L,IAAT,EAAe6B,GAAf,EAAoB+G,OAApB,EAAgC;AACvDkI,kBAAepF,MAAf;AACA0F,0BAAuBpR,IAAvB;;AAEA,OAAIf,EAAE8S,MAAF,CAASlQ,GAAT,KAAiB,EAAE+G,WAAWA,QAAQiB,YAArB,CAArB,EAAyD;AACvD,WAAM,IAAIlC,KAAJ,CAAU,kEAAV,CAAN;AACD,IAFD,MAGK,IAAIiB,WAAWA,QAAQiB,YAAvB,EAAqC;AACxCkH,kBAAanI,QAAQiB,YAArB;AACD,IAFI,MAGD;AACF0H,iBAAY1P,GAAZ;AACD;;AAED,OAAI+G,WAAWA,QAAQI,aAAvB,EAAsC;AACpCgI,0BAAqBpI,QAAQI,aAA7B;AACD;;AAED,OAAIJ,WAAWA,QAAQuB,MAAvB,EAA+B;AAC7B+G,oBAAetI,QAAQuB,MAAvB;AACD;;AAED,UAAO;AACLpK,eAAU,UADL;AAELC,WAAM,YAFD;AAGL0I,WAAM,iBAAiB1I,IAAjB,GAAwB,MAAxB,GAAiC6B,GAHlC;AAILjB,UAAK;AACHiR,WAAInG,MADD;AAEH1L,aAAMA,IAFH;AAGH6B,YAAKA,GAHF;AAIH6H,mBAAad,WAAWA,QAAQc,UAJ7B;AAKHG,qBAAejB,WAAWA,QAAQiB,YAL/B;AAMHM,eAASvB,WAAWA,QAAQuB,MANzB;AAOHnB,sBAAeJ,WAAWA,QAAQI,aAP/B;AAQHlI,iBAAU8H,WAAWA,QAAQ9H,QAR1B;AASHD,qBAAc+H,WAAWA,QAAQ/H;AAT9B;AAJA,IAAP;AAgBD,EAtCD;;AAwCA,KAAMmR,iBAAiB,SAAjBA,cAAiB,CAACtG,MAAD,EAASvC,OAAT,EAAkBP,OAAlB,EAA8B;AACnDkI,kBAAepF,MAAf;AACA8F,2BAAwBrI,OAAxB;;AAEA,OAAIP,WAAWA,QAAQuB,MAAvB,EAA+B;AAC7B+G,oBAAetI,QAAQuB,MAAvB;AACD;;AAED,UAAO;AACLpK,eAAU,UADL;AAELC,WAAM,UAFD;AAGL0I,WAAM,eAAeS,QAAQC,aAAvB,GAAuC,GAHxC;AAILxI,UAAK;AACHiR,WAAInG,MADD;AAEHvC,gBAASA,OAFN;AAGHgB,eAASvB,WAAWA,QAAQuB,MAHzB;AAIHrJ,iBAAU8H,WAAWA,QAAQ9H,QAJ1B;AAKHD,qBAAc+H,WAAWA,QAAQ/H;AAL9B;AAJA,IAAP;AAYD,EApBD;;AAsBA,KAAMoR,eAAe,SAAfA,YAAe,CAACvG,MAAD,EAASvB,MAAT,EAAoB;AACvC2G,kBAAepF,MAAf;AACAwF,kBAAe/G,MAAf;;AAEA,UAAO;AACLpK,eAAU,UADL;AAELC,WAAM,QAFD;AAGL0I,WAAM,aAAayB,MAHd;AAILvJ,UAAK;AACHiR,WAAInG,MADD;AAEHvB,eAAQA;AAFL;AAJA,IAAP;AASD,EAbD;;AAeA,KAAM+H,aAAa,SAAbA,UAAa,CAACxG,MAAD,EAAY;AAC7BoF,kBAAepF,MAAf;;AAEA,UAAO;AACL3L,eAAU,UADL;AAELC,WAAM,MAFD;AAGL0I,WAAM,cAHD;AAIL9H,UAAK;AACHiR,WAAInG;AADD;AAJA,IAAP;AAQD,EAXD;;AAaA,KAAMyG,uBAAuB,SAAvBA,oBAAuB,CAAC3I,QAAD,EAAc;AACzC,OAAI,CAACA,QAAL,EAAe;AACb,YAAO;AACLzJ,iBAAU,UADL;AAELC,aAAM,iBAFD;AAGL0I,aAAM,4BAHD;AAIL9H,YAAK;AACHwR,iBAAQ;AADL;AAJA,MAAP;AAQD;;AAEDV,0BAAuBlI,QAAvB;AACA,UAAO;AACLzJ,eAAU,UADL;AAELC,WAAM,iBAFD;AAGL0I,WAAM,0BAA0Bc,SAAST,MAAnC,GAA4C,QAH7C;AAILnI,UAAK;AACHwR,eAAQ,KADL;AAEH5I,iBAAUA;AAFP;AAJA,IAAP;AASD,EAtBD;;AAwBA,KAAM6I,qBAAqB,SAArBA,kBAAqB,CAAC3J,IAAD,EAAU;AACnC,OAAIA,QAAQA,KAAKK,MAAL,GAAc,GAA1B,EAA+B;AAC7B,WAAM,IAAIpB,KAAJ,CAAU,2CAAV,CAAN;AACD;;AAED,UAAO;AACL5H,eAAU,UADL;AAELC,WAAM,eAFD;AAGL0I,WAAM,wBAAwBA,IAHzB;AAIL9H,UAAK;AACH8H,aAAMA;AADH;AAJA,IAAP;AAQD,EAbD;;AAeA,KAAM4J,mBAAmB,SAAnBA,gBAAmB,CAAC3D,QAAD,EAAc;AACrC,UAAO;AACL5O,eAAU,UADL;AAELC,WAAM,aAFD;AAGL0I,WAAM,iCAAiC,CAAC,CAACiG,QAHpC;AAIL/N,UAAK;AACH2R,gBAAS,CAAC,CAAC5D,QADR;AAEHA,iBAAUA;AAFP;AAJA,IAAP;AASD,EAVD;;AAYA,KAAM6D,2BAA2B,SAA3BA,wBAA2B,CAAClG,OAAD,EAAa;AAC5C,OAAIA,WAAW,CAACrN,EAAEwT,KAAF,CAAQnG,OAAR,EAAiBrN,EAAEyT,QAAnB,CAAhB,EAA8C;AAC5C,WAAM,IAAI/K,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,UAAO;AACL5H,eAAU,UADL;AAELC,WAAM,qBAFD;AAGL0I,WAAM,6BAHD;AAIL9H,UAAK;AACH0L,gBAASA;AADN;AAJA,IAAP;AAQD,EAbD;;AAeA1J,QAAOC,OAAP,GAAiB;AACf+O,yBADe;AAEfE,qCAFe;AAGfE,iCAHe;AAIfC,6BAJe;AAKfC,yBALe;AAMfI,qCANe;AAOfH,6CAPe;AAQfE,yCARe;AASfG;AATe,EAAjB,C;;;;;;;;ACpQA,KAAMG,gBAAgB,SAAhBA,aAAgB,CAAC7S,IAAD,EAAO6F,OAAP,EAAmB;AACvC,UAAOA,QAAQ3E,IAAR,CAAa,eAAO;AACzBlB;AACA,YAAOyG,GAAP;AACD,IAHM,EAIN9D,KAJM,CAIA,eAAO;AACZ3C,UAAK6C,GAAL;AACA,WAAMA,GAAN;AACD,IAPM,CAAP;AAQD,EATD;;AAWA,KAAMiQ,aAAa,SAAbA,UAAa,CAAC/S,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AAC7C,UAAOkT,cAAc7S,IAAd,EAAoBL,UAAUoT,eAAV,CACzBhT,MAAMe,GAAN,CAAUiR,EADe,EAEzBhS,MAAMe,GAAN,CAAU4B,OAFe,EAGzB3C,MAAMe,GAAN,CAAUoI,aAHe,EAIzBnJ,MAAMe,GAJmB,CAApB,CAAP;AAKD,EAND;;AAQA,KAAMkS,mBAAmB,SAAnBA,gBAAmB,CAACjT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AACnD,UAAOkT,cAAc7S,IAAd,EAAoBL,UAAUsT,cAAV,CACzBlT,MAAMe,GAAN,CAAUiR,EADe,EAEzBhS,MAAMe,GAAN,CAAUZ,IAFe,EAGzBH,MAAMe,GAAN,CAAUiB,GAHe,EAIzBhC,MAAMe,GAAN,CAAUoI,aAJe,EAKzBnJ,MAAMe,GALmB,CAApB,CAAP;AAMD,EAPD;;AASA,KAAMoS,iBAAiB,SAAjBA,cAAiB,CAACnT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AACjD,UAAOkT,cAAc7S,IAAd,EAAoBL,UAAU8J,YAAV,CACzB1J,MAAMe,GAAN,CAAUiR,EADe,EAEzBhS,MAAMe,GAAN,CAAUuI,OAFe,EAGzBtJ,MAAMe,GAHmB,CAApB,CAAP;AAID,EALD;;AAOA,KAAMqS,eAAe,SAAfA,YAAe,CAACpT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AAC/C,UAAOkT,cAAc7S,IAAd,EAAoBL,UAAU6K,mBAAV,CACzBzK,MAAMe,GAAN,CAAUiR,EADe,EAEzBhS,MAAMe,GAAN,CAAUuJ,MAFe,CAApB,CAAP;AAGD,EAJD;;AAMA,KAAM+I,aAAa,SAAbA,UAAa,CAACrT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AAC7C,UAAOkT,cAAc7S,IAAd,EACLL,UAAU+L,UAAV,CAAqB3L,MAAMe,GAAN,CAAUiR,EAA/B,EAAmC,WAAnC,CADK,CAAP;AAED,EAHD;;AAKA,KAAMsB,mBAAmB,SAAnBA,gBAAmB,CAACtT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AACnD,OAAII,MAAMe,GAAN,CAAU2R,OAAd,EAAuB;AACrB,YAAOI,cAAc7S,IAAd,EACLL,UAAUwN,mBAAV,CAA8BpN,MAAMe,GAAN,CAAU+N,QAAxC,CADK,CAAP;AAED,IAHD,MAGO;AACL,YAAOgE,cAAc7S,IAAd,EAAoBL,UAAUyN,sBAAV,EAApB,CAAP;AACD;AACF,EAPD;;AASA,KAAMkG,uBAAuB,SAAvBA,oBAAuB,CAACvT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AACvD,OAAII,MAAMe,GAAN,CAAUwR,MAAd,EAAsB;AACpB,YAAOO,cAAc7S,IAAd,EAAoBL,UAAUkO,oBAAV,EAApB,CAAP;AACD,IAFD,MAEO;AACL,YAAOgF,cAAc7S,IAAd,EACLL,UAAUiO,iBAAV,CAA4B7N,MAAMe,GAAN,CAAU4I,QAAtC,CADK,CAAP;AAED;AACF,EAPD;;AASA,KAAM6J,qBAAqB,SAArBA,kBAAqB,CAACxT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AACrD,OAAII,MAAMe,GAAN,CAAU8H,IAAd,EAAoB;AAClB,YAAOiK,cAAc7S,IAAd,EACLL,UAAU6N,eAAV,CAA0BzN,MAAMe,GAAN,CAAU8H,IAApC,CADK,CAAP;AAED,IAHD,MAGO;AACL,YAAOiK,cAAc7S,IAAd,EAAoBL,UAAU4N,kBAAV,CAA6BxN,MAAMe,GAAN,CAAU8H,IAAvC,CAApB,CAAP;AACD;AACF,EAPD;;AASA,KAAM4K,2BAA2B,SAA3BA,wBAA2B,CAACzT,KAAD,EAAQC,IAAR,EAAcL,SAAd,EAA4B;AAC3D,UAAOkT,cAAc7S,IAAd,EACLL,UAAUsO,qBAAV,CAAgClO,MAAMe,GAAN,CAAU0L,OAA1C,CADK,CAAP;AAED,EAHD;;AAKA1J,QAAOC,OAAP,GAAiB;AACf,WAAQ+P,UADO;AAEf,iBAAcE,gBAFC;AAGf,eAAYE,cAHG;AAIf,aAAUC,YAJK;AAKf,WAAQC,UALO;AAMf,oBAAiBG,kBANF;AAOf,sBAAmBD,oBAPJ;AAQf,0BAAuBE,wBARR;AASf,kBAAeH,gBATA;AAUfxT,YAAS;AAVM,EAAjB,C;;;;;;;;AC9EA;;;;AAEA;;;;AACA;;;;AACA;;;;;;AAEAiD,QAAOC,OAAP,GAAiB,UAAC3B,EAAD,EAAKzB,SAAL,EAAmB;;AAElC,OAAM8T,QAAQ,qBAAMrS,EAAN,EAAUzB,SAAV,CAAd;;AAEA,OAAM+T,gBAAgB,wBAAI;AACxBC,UAAK,KADmB;AAExBC,aAAQ,KAAK,EAAL,GAAU;AAFM,IAAJ,CAAtB;;AAKA,OAAMC,kBAAkB,SAAlBA,eAAkB,UAAW;AACjC,SAAMjI,SAASvC,QAAQuF,MAAR,CAAezE,EAA9B;AACA,SAAMvJ,MAAMyI,QAAQ3G,OAAR,IAAmB2G,QAAQ3G,OAAR,CAAgB9B,GAA/C;;AAEA,SAAIA,OAAO,CAAC8S,cAAcI,GAAd,CAAkBlT,GAAlB,CAAZ,EAAoC;AAClC;AACAyI,eAAQ0K,gBAAR,GAA2B,IAA3B;AACD,MAHD,MAGO;AACL;AACAL,qBAAcM,GAAd,CAAkBpT,GAAlB,EAAuB,IAAvB;AACD;;AAED,YAAO6S,MAAMQ,qBAAN,CAA4BrI,MAA5B,CAAP;AACD,IAbD;;AAeAjM,aAAUsG,EAAV,CAAa,SAAb,EAAwB,aAAK;AAC3B4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACf;AACAE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,SAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAE1D,OAAF,CAAUkG,IAJU;AAK1B9H,cAAKsF;AALqB,QAA5B;AAOD,MAVD;AAWD,IAZD;;AAcAzG,aAAUsG,EAAV,CAAa,YAAb,EAA2B,aAAK;AAC9B4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,aAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAE1D,OAAF,CAAUgN,WAAV,CAAsBzG,MAAtB,GAA+B,cAJX;AAK1BnI,cAAKsF;AALqB,QAA5B;AAOAA,SAAE1D,OAAF,CAAUgN,WAAV,CAAsBN,OAAtB,CAA8B,eAAO;AACnChO,YAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,qBAAU,UADgB;AAE1BC,iBAAMmU,IAAInU,IAFgB;AAG1BiU,iBAAMC,OAHoB;AAI1BxL,iBAAMyL,IAAIhL,OAAJ,CAAYtH,GAAZ,GACJsS,IAAIhL,OAAJ,CAAYtH,GADR,GAEFmF,KAAKwD,SAAL,CAAe2J,IAAIhL,OAAnB,CANsB;AAO1BvI,gBAAKuT;AAPqB,UAA5B;AASD,QAVD;AAWD,MApBD;AAqBD,IAtBD;;AAwBA1U,aAAUsG,EAAV,CAAa,UAAb,EAAyB,aAAK;AAC5B4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,UAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAEyI,QAAF,CAAWxF,OAJS;AAK1BvI,cAAKsF;AALqB,QAA5B;;AAQA,WAAIA,EAAEyI,QAAF,CAAWxF,OAAX,KAAuB,aAA3B,EAA0C;AACxC,aAAMiL,UAAU3U,UAAUyC,SAAV,EAAhB;;AAEA,aAAIkS,QAAQ5Q,iBAAR,IAA6B4Q,QAAQ9P,kBAAR,IAA8B,kBAA/D,EAAmF;AACjFpD,cAAGzB,SAAH,CAAa4U,QAAb,CAAsBH,QAAQjK,EAA9B,EAAkCmK,QAAQ7P,gBAA1C;AACD;;AAED,aAAI6P,QAAQ5Q,iBAAR,IAA6B4Q,QAAQ9P,kBAAR,IAA8B,sBAA/D,EAAuF;AACrFpD,cAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,uBAAU,UADgB;AAE1BC,mBAAM,UAFoB;AAG1BiU,mBAAMC,OAHoB;AAI1BxL,mBAAM0L,QAAQ5P,oBAJY;AAK1B5D,kBAAKsF;AALqB,YAA5B;AAOD;AACF;AACF,MA3BD;AA4BD,IA7BD;;AA+BAzG,aAAUsG,EAAV,CAAa,aAAb,EAA4B,aAAK;AAC/B4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,aAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAE1D,OAAF,CAAUoM,WAAV,CAAsBzF,OAJF;AAK1BvI,cAAKsF;AALqB,QAA5B;AAOD,MATD;AAUD,IAXD;;AAaAzG,aAAUsG,EAAV,CAAa,UAAb,EAAyB,aAAK;;AAE5B,sBAAEuO,MAAF,CAAS,mBAAS3U,OAAlB,EAA2BuP,OAA3B,CAAmC,mBAAW;AAC5C,WAAMlF,YAAYrK,QAAQE,KAAR,CAAce,GAAd,CAAkBiR,EAApC;AACA,WAAI3L,EAAEwI,MAAF,CAASzE,EAAT,KAAgBD,SAAhB,IAA6BrK,QAAQE,KAAR,CAAce,GAAd,CAAkBC,YAAnD,EAAiE;AAC/D,aAAI,iBAAEwQ,QAAF,CAAWnL,EAAEyJ,QAAF,CAAW4E,IAAtB,EAA4B5U,QAAQe,GAApC,CAAJ,EAA8C;AAC5Cf,mBAAQ4B,OAAR,CAAgB2E,CAAhB;AACA,kBAAO,mBAASvG,OAAT,CAAiBA,QAAQE,KAAR,CAAcM,IAA/B,CAAP;AACD;AACF;AACF,MARD;;AAUAwT,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,UAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAEyJ,QAAF,CAAW6E,SAAX,CAAqBC,QAArB,EAJoB;AAK1B7T,cAAKsF;AALqB,QAA5B;AAOD,MATD;AAUD,IAtBD;;AAwBAzG,aAAUsG,EAAV,CAAa,MAAb,EAAqB,aAAK;;AAExB,sBAAEuO,MAAF,CAAS,mBAAS3U,OAAlB,EAA2BuP,OAA3B,CAAmC,mBAAW;AAC5C,WAAMlF,YAAYrK,QAAQE,KAAR,CAAce,GAAd,CAAkBiR,EAApC;AACA,WAAI3L,EAAEwI,MAAF,CAASzE,EAAT,KAAgBD,SAApB,EAA+B;AAC7B,aAAIrK,QAAQE,KAAR,CAAce,GAAd,CAAkBE,QAAlB,IACCnB,QAAQa,SADT,IAECb,QAAQa,SAAR,IAAqB0F,EAAE0J,IAAF,CAAO4E,SAFjC,EAE4C;AAC1C7U,mBAAQ4B,OAAR,CAAgB2E,CAAhB;AACA,kBAAO,mBAASvG,OAAT,CAAiBA,QAAQE,KAAR,CAAcM,IAA/B,CAAP;AACD;AACF;AACF,MAVD;;AAYAwT,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,MAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAE0J,IAAF,CAAO4E,SAAP,CAAiBC,QAAjB,EAJoB;AAK1B7T,cAAKsF;AALqB,QAA5B;AAOD,MATD;AAUD,IAxBD;;AA0BAzG,aAAUsG,EAAV,CAAa,iBAAb,EAAgC,YAAM;AACpC7E,QAAGM,MAAH,CAAUkT,IAAV,CAAe,gFAAf;AACD,IAFD;;AAIAjV,aAAUsG,EAAV,CAAa,OAAb,EAAsB,aAAK;AACzB4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,OAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAE4J,KAAF,CAAQ6E,GAJY;AAK1B/T,cAAKsF;AALqB,QAA5B;AAOD,MATD;AAUD,IAXD;;AAaAzG,aAAUsG,EAAV,CAAa,UAAb,EAAyB,aAAK;AAC5B4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAW;AACfE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,UAFoB;AAG1BiU,eAAMC,OAHoB;AAI1BxL,eAAMxC,EAAE6J,QAAF,CAAW4E,GAJS;AAK1B/T,cAAKsF;AALqB,QAA5B;AAOD,MATD;AAUD,IAXD;;AAaAzG,aAAUsG,EAAV,CAAa,SAAb,EAAwB,aAAI;AAC1B4N,qBAAgBzN,CAAhB,EACClF,IADD,CACM,mBAAU;AACdE,UAAGyD,WAAH,CAAeqP,YAAf,CAA4B;AAC1BjU,mBAAU,UADgB;AAE1BC,eAAM,SAFoB;AAG1B0I,eAAM,SAHoB;AAI1BuL,eAAMC,OAJoB;AAK1BlE,kBAAS9J,EAAE8J,OALe;AAM1BpP,cAAKsF;AANqB,QAA5B;AAQD,MAVD;AAWD,IAZD;AAcD,EAxMD,C;;;;;;ACNA,uC;;;;;;ACAA;;AAEA;;;;;;;;;;;;AAYA,KAAM/G,UAAU,mBAAAL,CAAQ,CAAR,CAAhB;AACA,KAAMC,OAAO,mBAAAD,CAAQ,CAAR,CAAb;AACA,KAAME,KAAK,mBAAAF,CAAQ,CAAR,CAAX;;AAEA8D,QAAOC,OAAP,GAAiB,UAAS3B,EAAT,EAAazB,SAAb,EAAwB;;AAEvC,OAAMmV,WAAW7V,KAAKoI,IAAL,CACfjG,GAAG2T,YADY,EAEf,kCAFe,CAAjB;;AAKA,OAAMC,mBAAmB,SAAnBA,gBAAmB,GAAM;AAC7B,SAAI9V,GAAG+V,UAAH,CAAcH,QAAd,CAAJ,EAA6B;AAC3B,cAAO5N,KAAKC,KAAL,CAAWjI,GAAGkI,YAAH,CAAgB0N,QAAhB,CAAX,CAAP;AACD;AACD,YAAO,EAAP;AACD,IALD;;AAOA,OAAMI,mBAAmB,SAAnBA,gBAAmB,CAACC,QAAD,EAAc;AACrC,SAAMC,UAAUlO,KAAKwD,SAAL,CAAeyK,QAAf,CAAhB;AACAjW,QAAGmW,aAAH,CAAiBP,QAAjB,EAA2BM,OAA3B;AACAhU,QAAGM,MAAH,CAAUC,KAAV,CAAgB,wCAAhB;AACD,IAJD;;AAMA,OAAM2T,eAAeN,kBAArB;AACA,OAAIO,UAAU,IAAI/P,IAAJ,EAAd;;AAEA,UAAO;AACLyO,4BAAuB5U,QAAQwB,MAAR,CAAe,UAAC+K,MAAD,EAAY;AAChD,WAAI0J,aAAa1J,MAAb,CAAJ,EAA0B;AACxB,gBAAO0J,aAAa1J,MAAb,CAAP;AACD;;AAED,cAAOjM,UAAU6V,cAAV,CAAyB5J,MAAzB,EACN1K,IADM,CACD,UAACkT,OAAD,EAAa;AACjBA,iBAAQjK,EAAR,GAAayB,MAAb;AACA0J,sBAAa1J,MAAb,IAAuBwI,OAAvB;AACA,aAAI,IAAI5O,IAAJ,KAAa+P,OAAb,IAAwB,KAA5B,EAAmC;AACjCL,4BAAiBI,YAAjB;AACAC,qBAAU,IAAI/P,IAAJ,EAAV;AACD;;AAED,gBAAOpE,GAAGqU,EAAH,CAAMC,QAAN,CAAe;AACpBvL,eAAIiK,QAAQjK,EADQ;AAEpBlK,qBAAU,UAFU;AAGpB0V,mBAAQvB,QAAQuB,MAHI;AAIpBC,qBAAUxB,QAAQwB,QAJE;AAKpBC,mBAAQzB,QAAQyB,MALI;AAMpBC,wBAAa1B,QAAQ2B,WAND;AAOpBC,uBAAY5B,QAAQ4B,UAPA;AAQpBC,sBAAW7B,QAAQ6B;AARC,UAAf,EASJC,MATI,CASG9B,OATH,CAAP;AAWD,QApBM,CAAP;AAqBD,MA1BsB;AADlB,IAAP;AA6BD,EApDD,C;;;;;;AClBA;;AAEA,KAAM/U,UAAU,mBAAAL,CAAQ,CAAR,CAAhB;AACA,KAAMU,QAAQ,mBAAAV,CAAQ,EAAR,CAAd;AACA,KAAI+C,MAAM,IAAV;;AAEAe,QAAOC,OAAP,GAAiB;AACfnB,WAAQ,gBAACE,IAAD,EAAU;AAChB,SAAIC,GAAJ,EAAS;AACP,cAAO1C,QAAQoC,OAAR,CAAgBM,GAAhB,CAAP;AACD;;AAED,YAAO1C,QAAQ8W,YAAR,CAAqB,oBAAY;AACtCzW,aAAM4C,OAAN,CAAcR,QAAQ,IAAtB,EAA4BsU,QAA5B;AACD,MAFM,EAGNlV,IAHM,CAGD;AAAA,cAAKa,MAAMsU,CAAX;AAAA,MAHC,CAAP;AAID,IAVc;AAWfC,SAAM,gBAAM;AACV,SAAIvU,GAAJ,EAAS;AACPrC,aAAMoH,UAAN,CAAiB/E,GAAjB;AACAA,aAAM,IAAN;AACD;AACF;AAhBc,EAAjB,C;;;;;;ACNA,mC","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/Desktop/botpress-messenger\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap ae66f3695110db84926b","const checkVersion = require('botpress-version-manager')\n\nconst path = require('path')\nconst fs = require('fs')\nconst _ = require('lodash')\nconst uuid = require('uuid')\nconst Promise = require('bluebird')\n\nconst Messenger = require('./messenger')\nconst actions = require('./actions')\nconst outgoing = require('./outgoing')\nconst incoming = require('./incoming')\nconst ngrok = require('./ngrok')\n\nlet messenger = null\nconst outgoingPending = outgoing.pending\n\nconst outgoingMiddleware = (event, next) => {\n  if (event.platform !== 'facebook') {\n    return next()\n  }\n\n  if (!outgoing[event.type]) {\n    return next('Unsupported event type: ' + event.type)\n  }\n\n  const setValue = method => (...args) => {\n    if (event.__id && outgoingPending[event.__id]) {\n\n      if (args && args[0] && args[0].message_id) {\n        let ts = args[0].message_id.split(':')[0]\n        ts = ts && ts.substr(4)\n        outgoingPending[event.__id].timestamp = parseInt(ts)\n        outgoingPending[event.__id].mid = args[0].message_id\n      }\n\n      if (method === 'resolve' && (event.raw.waitDelivery || event.raw.waitRead)) {\n        // We skip setting this value because we wait\n      } else {\n        outgoingPending[event.__id][method].apply(null, args)\n        delete outgoingPending[event.__id]\n      }\n    }\n  }\n  \n  outgoing[event.type](event, next, messenger)\n  .then(setValue('resolve'), setValue('reject'))\n}\n\nconst initializeMessenger = (bp, configurator) => {\n  return configurator.loadAll()\n  .then(config => {\n    messenger = new Messenger(bp, config)\n\n    // regenerate a new ngrok url and update it to facebook\n    if (!config.ngrok || !config.connected) {\n      return Promise.resolve(true)\n    }\n\n    bp.logger.debug('[messenger] updating ngrok to facebook')\n\n    return ngrok.getUrl(bp.botfile.port)\n    .then(url => {\n      url = url.replace(/https:\\/\\//i, '')\n      messenger.setConfig({ hostname: url })\n    })\n    .then(() => configurator.saveAll(messenger.getConfig()))\n    .then(() => messenger.updateSettings())\n    .then(() => messenger.connect())\n    .then(() => bp.notifications.send({\n      level: 'info',\n      message: 'Upgraded messenger app webhook with new ngrok url'\n    }))\n    .catch(err => {\n      bp.logger.error('[messenger] error updating ngrok', err)\n      bp.notifications.send({\n        level: 'error',\n        message: 'Error updating app webhook with new ngrok url. Please see logs for details.'\n      })\n    })\n  })\n}\n\nmodule.exports = {\n\n  config: {\n    applicationID: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_ID' },\n    accessToken: { type: 'string', required: true, default: '', env: 'MESSENGER_ACCESS_TOKEN' },\n    appSecret: { type: 'string', required: true, default: '', env: 'MESSENGER_APP_SECRET' },\n    verifyToken: { type: 'string', required: false, default: uuid.v4() },\n    validated: { type: 'bool', required: false, default: false },\n    connected: { type: 'bool', required: false, default: false },\n    hostname: { type: 'string', required: false, default: '' },\n    homepage: { type: 'string' },\n    ngrok: { type: 'bool', required: false, default: false },\n    displayGetStarted: { type: 'bool', required: false, default: false },\n    greetingMessage: { type: 'string', required: false, default: 'Default greeting message' },\n    persistentMenu: { type: 'bool', required: false, default: false },\n    persistentMenuItems: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    automaticallyMarkAsRead: { type: 'bool', required: false, default: true },\n    targetAudience: { type: 'string', required: true, default: 'openToAll'},\n    targetAudienceOpenToSome: { type: 'string', required: false },\n    targetAudienceCloseToSome: { type: 'string', required: false },\n    trustedDomains: { type: 'any', required: false, default: [], validation: v => _.isArray(v) },\n    autoRespondGetStarted: { type: 'bool', required: false, default: true }, // deprecated\n    autoResponse: { type: 'string', required: false, default: 'Hello!' },     // deprecated\n    autoResponseOption: { type: 'string', required: false, default: 'noResponse' },\n    autoResponseText: { type: 'string', required: false, default: 'Hello, human!' },\n    autoResponsePostback: { type: 'string', required: false, default: 'YOUR_POSTBACK' }\n  },\n\n  init: function(bp) {\n\n    checkVersion(bp, __dirname)\n\n    bp.middlewares.register({\n      name: 'messenger.sendMessages',\n      type: 'outgoing',\n      order: 100,\n      handler: outgoingMiddleware,\n      module: 'botpress-messenger',\n      description: 'Sends out messages that targets platform = messenger.' +\n      ' This middleware should be placed at the end as it swallows events once sent.'\n    })\n\n    bp.messenger = {}\n    _.forIn(actions, (action, name) => {\n      bp.messenger[name] = action\n      var sendName = name.replace(/^create/, 'send')\n      bp.messenger[sendName] = Promise.method(function() {\n        var msg = action.apply(this, arguments)\n        msg.__id = new Date().toISOString() + Math.random()\n        const resolver = { event: msg }\n        \n        const promise = new Promise(function(resolve, reject) {\n          resolver.resolve = resolve\n          resolver.reject = reject\n        })\n        \n        outgoingPending[msg.__id] = resolver\n        \n        bp.middlewares.sendOutgoing(msg)\n        return promise\n      })\n    })\n  },\n\n  ready: function(bp, config) {\n\n    initializeMessenger(bp, config)\n    .then(() => {\n      incoming(bp, messenger)\n\n      messenger.on('raw_webhook_body', e => {\n        bp.events.emit('messenger.raw_webhook_body', e)\n      })\n\n      messenger.on('raw_send_request', e => {\n        bp.events.emit('messenger.raw_send_body', e)\n      })\n\n      const router = bp.getRouter('botpress-messenger')\n\n      router.get('/config', (req, res) => {\n        res.send(messenger.getConfig())\n      })\n\n      router.post('/config', (req, res) => {\n        messenger.setConfig(req.body)\n        config.saveAll(messenger.getConfig())\n        .then(() => messenger.updateSettings())\n        .then(() => res.sendStatus(200))\n        .catch((err) => {\n          res.status(500).send({ message: err.message })\n        })\n      })\n\n      router.get('/ngrok', (req, res) => {\n        ngrok.getUrl()\n        .then(url => res.send(url))\n      })\n\n      router.post('/connection', (req, res) => {\n        if (messenger.getConfig().connected) {\n          messenger.disconnect()\n          .then(() => res.sendStatus(200))\n          .catch((err) => res.status(500).send({ message: err.message }))\n        } else {\n          messenger.connect()\n          .then(() => res.sendStatus(200))\n          .catch((err) => res.status(500).send({ message: err.message }))\n        }\n      })\n\n      router.post('/validation', (req, res) => {\n        messenger.sendValidationRequest()\n        .then((json) => {\n          res.send(json)\n        })\n        .catch((err) => {\n          res.status(500).send({ message: err.message })\n        })\n      })\n\n      router.get('/homepage', (req, res) => {\n        const packageJSON = JSON.parse(fs.readFileSync(path.join(__dirname, '../package.json')))\n        res.send({ homepage: packageJSON.homepage })\n      })\n\n    })\n\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"uuid\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"uuid\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 7\n// module chunks = 0","/**\n * Messenger\n *\n * This file contains one class Messenger, which in charge of communication between\n * botpress and fb messenger.\n *\n */\n\nconst Promise = require('bluebird')\nconst EventEmitter = require('eventemitter2')\nconst crypto = require('crypto')\nconst fetch = require('node-fetch')\nconst _ = require('lodash')\nconst bodyParser = require('body-parser')\n\nfetch.promise = Promise\n\nconst normalizeString = function(str) {\n  return str.replace(/[^a-zA-Z0-9]+/g, '').toUpperCase()\n}\n\nclass Messenger extends EventEmitter {\n  constructor(bp, config) {\n    super()\n    if (!bp || !config) {\n      throw new Error('You need to specify botpress and config')\n    }\n\n    this.setConfig(config)\n\n    this.app = bp.getRouter('botpress-messenger', {\n      'bodyParser.json': false,\n      'auth': req => !/\\/webhook/i.test(req.originalUrl)\n    })\n\n    this.app.use(bodyParser.json({\n      verify: this._verifyRequestSignature.bind(this)\n    }))\n\n    this._initWebhook()\n  }\n\n  setConfig(config) {\n    this.config = Object.assign({}, this.config, config)\n  }\n\n  getConfig() {\n    return this.config\n  }\n\n  connect() {\n    return this._setupNewWebhook()\n    .then(() => this._subscribePage())\n  }\n\n  disconnect() {\n    return this._unsubscribePage()\n  }\n\n  sendTextMessage(recipientId, text, quickReplies, options) {\n    const message = { text }\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  sendButtonTemplate(recipientId, text, buttons, options) {\n    const payload = {\n      template_type: 'button',\n      text\n    }\n    const formattedButtons = this._formatButtons(buttons)\n    payload.buttons = formattedButtons\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendGenericTemplate(recipientId, elements, options) {\n    const payload = {\n      template_type: 'generic',\n      elements\n    }\n    return this.sendTemplate(recipientId, payload, options)\n  }\n\n  sendTemplate(recipientId, payload, options) {\n    const message = {\n      attachment: {\n        type: 'template',\n        payload\n      }\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  sendAttachment(recipientId, type, url, quickReplies, options) {\n    const message = {\n      attachment: {\n        type,\n        payload: { url }\n      }\n    }\n    if( options.isReusable && _.isBoolean(options.isReusable) ){\n      message.attachment.payload.is_reusable = options.isReusable;\n    }\n    if( options.attachmentId ){\n      message.attachment.payload = {\n        attachment_id: options.attachmentId\n      }\n    }\n    const formattedQuickReplies = this._formatQuickReplies(quickReplies)\n    if (formattedQuickReplies && formattedQuickReplies.length > 0) {\n      message.quick_replies = formattedQuickReplies\n    }\n    return this.sendMessage(recipientId, message, options)\n  }\n\n  sendAction(recipientId, action) {\n    return this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      sender_action: action\n    })\n  }\n\n  sendMessage(recipientId, message, options) {\n    const req = () => this.sendRequest({\n      recipient: {\n        id: recipientId\n      },\n      message\n    })\n\n    if (options && options.typing) {\n      const autoTimeout = (message && message.text) ? 500 + message.text.length * 10 : 1000\n      const timeout = (typeof options.typing === 'number') ? options.typing : autoTimeout\n      return this.sendTypingIndicator(recipientId, timeout).then(req)\n    }\n\n    return req()\n  }\n\n  sendValidationRequest() {\n    const applicationID = this.config.applicationID\n    const accessToken = this.config.accessToken\n\n    return fetch(`https://graph.facebook.com/v2.7/${applicationID}/subscriptions_sample`, {\n      method: 'POST',\n      headers: {'Content-Type': 'application/json'},\n      body: JSON.stringify({\n        object_id: applicationID,\n        object: 'page',\n        field: 'messages',\n        custom_fields: { page_id: applicationID },\n        access_token: accessToken\n      })\n    })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n  }\n\n  sendRequest(body, endpoint, method) {\n    endpoint = endpoint || 'messages'\n    method = method || 'POST'\n\n    const url = `https://graph.facebook.com/v2.7/me/${endpoint}`\n    return fetch(`${url}?access_token=${this.config.accessToken}`, {\n      method,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(body)\n    })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .then(json => {\n      this._handleEvent('raw_send_request', { url, token: this.config.accessToken, body, endpoint, method, response: json })\n      return json\n    })\n  }\n\n  sendThreadRequest(body, method) {\n    return this.sendRequest(body, 'thread_settings', method)\n  }\n\n  sendTypingIndicator(recipientId, milliseconds) {\n    let timeout = !milliseconds || isNaN(milliseconds) ? 0 : milliseconds\n    timeout = Math.min(20000, timeout)\n\n    if (milliseconds === true) {\n      timeout = 1000\n    }\n\n    const before = timeout > 0\n      ? Promise.resolve(this.sendAction(recipientId, 'typing_on'))\n      : Promise.resolve(true)\n\n    return before\n    .delay(timeout)\n    .then(() => this.sendAction(recipientId, 'typing_off'))\n  }\n\n  getUserProfile(userId) {\n    const url = `https://graph.facebook.com/v2.7/${userId}?fields=first_name,last_name,profile_pic,locale,timezone,gender&access_token=${this.config.accessToken}`\n    return fetch(url)\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .catch(err => console.log(`Error getting user profile: ${err}`))\n  }\n\n  createTargetAudienceSetting() {\n    var setting = { target_audience: {} }\n    \n    switch(this.config.targetAudience){\n      case 'openToAll':\n        setting.target_audience.audience_type = 'all'\n        break;\n      case 'openToSome':\n        var countriesWhitelist = this.config.targetAudienceOpenToSome.split(/\\, ?/g);\n        setting.target_audience.audience_type = 'custom'\n        setting.target_audience.countries = {\n          whitelist: countriesWhitelist\n        }\n        break;\n      case 'closeToSome':\n        setting.target_audience.audience_type = 'custom'\n        var countriesBlacklist = this.config.targetAudienceCloseToSome.split(/\\, ?/g);\n        setting.target_audience.countries = {\n          blacklist: countriesBlacklist\n        }\n        break;\n      case 'closeToAll':\n        setting.target_audience.audience_type = 'none'\n        break;\n    }\n\n    return setting;\n  }\n\n  setTargetAudience() {\n    const url = `https://graph.facebook.com/v2.7/me/messenger_profile?access_token=${this.config.accessToken}`\n    var setting = this.createTargetAudienceSetting();\n\n    return this.sendRequest(setting, 'messenger_profile', 'POST')\n  }\n\n  setWhitelistedDomains(domains) {\n    const url = `https://graph.facebook.com/v2.7/me/thread_settings?fields=whitelisted_domains&access_token=${this.config.accessToken}`\n    return fetch(url)\n      .then(this._handleFacebookResponse)\n      .then(res => res.json())\n      .then((json) => {\n        if (json && json.data && json.data[0]) {\n          return json.data[0].whitelisted_domains\n        } else {\n          return []\n        }\n      })\n      .then((oldDomains) => {\n        if (!oldDomains || !oldDomains.length) {\n          return\n        }\n\n        fetch(url, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            setting_type: 'domain_whitelisting',\n            whitelisted_domains: oldDomains,\n            domain_action_type: 'remove'\n          })\n        })\n      })\n      .then(this._handleFacebookResponse)\n      .then(() => fetch(url, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          setting_type: 'domain_whitelisting',\n          whitelisted_domains: domains,\n          domain_action_type: 'add'\n        })\n      }))\n      .then(this._handleFacebookResponse)\n  }\n\n  setGreetingText(text) {\n    return this.sendThreadRequest({\n      setting_type: 'greeting',\n      greeting: { text }\n    })\n  }\n\n  deleteGreetingText() {\n    return this.sendThreadRequest({\n      setting_type: 'greeting'\n    }, 'DELETE')\n  }\n\n  setGetStartedButton(action) {\n    const payload = (typeof action === 'string') ? action : 'GET_STARTED'\n    if (typeof action === 'function') {\n      this.on(`postback:${payload}`, action)\n    }\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'new_thread',\n      call_to_actions: [ { payload } ]\n    })\n  }\n\n  deleteGetStartedButton() {\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'new_thread'\n    }, 'DELETE')\n  }\n\n  setPersistentMenu(buttons) {\n    const formattedButtons = this._formatButtons(buttons)\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'existing_thread',\n      call_to_actions: formattedButtons\n    })\n  }\n\n  deletePersistentMenu() {\n    return this.sendThreadRequest({\n      setting_type: 'call_to_actions',\n      thread_state: 'existing_thread'\n    }, 'DELETE')\n  }\n\n  updateSettings() {\n    const updateGetStarted = () => this.config.displayGetStarted\n      ? this.setGetStartedButton()\n      : this.deleteGetStartedButton()\n\n    const updateGreetingText = () => _.isEmpty(this.config.greetingMessage)\n      ? this.deleteGreetingText()\n      : this.setGreetingText(this.config.greetingMessage)\n\n    const items = this._reformatPersistentMenuItems(this.config.persistentMenuItems)\n    const updatePersistentMenu = () => this.config.persistentMenu\n      ? this.setPersistentMenu(items)\n      : this.deletePersistentMenu()\n\n    const updateTargetAudience = () => this.setTargetAudience()\n\n    const updateTrustedDomains = () => this.setWhitelistedDomains(this.config.trustedDomains)\n\n    let thrown = false\n    const contextifyError = (context) => (err) => {\n      if (thrown) throw err\n      const message = `Error setting ${context}\\n${err.message}`\n      thrown = true\n      throw new Error(message)\n    }\n\n    return updateGetStarted()\n    .catch(contextifyError('get started'))\n    .then(updateGreetingText)\n    .catch(contextifyError('greeting text'))\n    .then(updatePersistentMenu)\n    .catch(contextifyError('persistent menu'))\n    .then(updateTargetAudience)\n    .catch(contextifyError('target audience'))\n    .then(updateTrustedDomains)\n    .catch(contextifyError('trusted domains'))\n  }\n\n  module(factory) {\n    return factory.apply(this, [ this ])\n  }\n\n  _formatButtons(buttons) {\n    return buttons && buttons.map((button) => {\n      if (typeof button === 'string') {\n        return {\n          type: 'postback',\n          title: button,\n          payload: 'BUTTON_' + normalizeString(button)\n        }\n      } else if (button && button.title) {\n        return button\n      }\n      return {}\n    })\n  }\n\n  _formatQuickReplies(quickReplies) {\n    return quickReplies && quickReplies.map((reply) => {\n      if (typeof reply === 'string') {\n        return {\n          content_type: 'text',\n          title: reply,\n          payload: 'QR_' + normalizeString(reply)\n        }\n      } else if (reply && reply.title) {\n        return {\n          content_type: reply.content_type || 'text',\n          title: reply.title,\n          payload: reply.payload || 'QR_' + normalizeString(reply.title),\n          image_url: reply.image_url\n        }\n      }\n      return {}\n    })\n  }\n\n  _handleEvent(type, event) {\n    this.emit(type, event)\n  }\n\n  _handleMessageEvent(event) {\n    const text = event.message.text\n    if (!text) { return }\n\n    this._handleEvent('message', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleAttachmentEvent(event) {\n    this._handleEvent('attachment', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handlePostbackEvent(event) {\n    const payload = event.postback.payload\n    if (payload) {\n      this._handleEvent(`postback:${payload}`, event)\n    }\n    this._handleEvent('postback', event)\n  }\n\n  _handleQuickReplyEvent(event) {\n    const payload = event.message.quick_reply && event.message.quick_reply.payload\n    if (payload) {\n      this._handleEvent(`quick_reply:${payload}`, event)\n    }\n    this._handleEvent('quick_reply', event)\n\n    if (event.message && this.config.automaticallyMarkAsRead) {\n      this.sendAction(event.sender.id, 'mark_seen')\n    }\n  }\n\n  _handleFacebookResponse(res) {\n    if (!res) return\n\n    if (res.status < 400) {\n      return res\n    }\n\n    let errorMessage = 'An error has been returned by Facebook API.'\n    errorMessage += '\\nStatus: ' + res.status + ' (' + res.statusText + ')'\n\n    return Promise.resolve(true)\n    .then(() => res.json())\n    .then(json => {\n      errorMessage += '\\n' + json.error.message\n    })\n    .finally(() => {\n      throw new Error(errorMessage)\n    })\n  }\n\n  _initWebhook() {\n    this.app.get('/webhook', (req, res) => {\n      if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === this.config.verifyToken) {\n\n        res.status(200).send(req.query['hub.challenge'])\n      } else {\n        console.error('Failed validation. Make sure the validation tokens match.')\n        res.sendStatus(403)\n      }\n    })\n\n    this.app.post('/webhook', (req, res) => {\n      var data = req.body\n      if (data.object !== 'page') {\n        return\n      }\n\n      this._handleEvent('raw_webhook_body', data)\n\n      // Iterate over each entry. There may be multiple if batched.\n      data.entry.forEach((entry) => {\n        if (entry && !entry.messaging) {\n          return\n        }\n        // Iterate over each messaging event\n        entry.messaging.forEach((event) => {\n          if (event.message && event.message.is_echo && !this.config.broadcastEchoes) {\n            return\n          }\n          if (event.message && event.message.text) {\n            if (event.message.quick_reply) {\n              this._handleQuickReplyEvent(event)\n            } else {\n              this._handleMessageEvent(event)\n            }\n          } else if (event.message && event.message.attachments) {\n            this._handleAttachmentEvent(event)\n          } else if (event.postback) {\n            this._handlePostbackEvent(event)\n          } else if (event.delivery) {\n            this._handleEvent('delivery', event)\n          } else if (event.read) {\n            this._handleEvent('read', event)\n          } else if (event.account_linking) {\n            this._handleEvent('account_linking', event)\n          } else if (event.optin) {\n            this._handleEvent('optin', event)\n          } else if (event.referral) {\n            this._handleEvent('referral', event)\n          } else if (event.payment){\n            this._handleEvent('payment', event)\n          }\n          else {\n            console.log('Webhook received unknown event: ', event)\n          }\n        })\n      })\n\n      // Must send back a 200 within 20 seconds or the request will time out.\n      res.sendStatus(200)\n    })\n  }\n\n  _verifyRequestSignature(req, res, buf) {\n    if (!/^\\/webhook/i.test(req.path)) {\n      return\n    }\n\n    var signature = req.headers['x-hub-signature']\n    if (!signature) {\n      throw new Error('Couldn\\'t validate the request signature.')\n    } else {\n      let [, hash] = signature.split('=')\n      var expectedHash = crypto.createHmac('sha1', this.config.appSecret).update(buf).digest('hex')\n\n      if (hash != expectedHash) {\n        throw new Error('Couldn\\'t validate the request signature.')\n      }\n    }\n  }\n\n  _reformatPersistentMenuItems() {\n    if (this.config.persistentMenu && this.config.persistentMenuItems) {\n      return this.config.persistentMenuItems.map((item) => {\n\n        if (item.value && item.type === 'postback') {\n          item.payload = item.value\n          delete item.value\n        } else if (item.value && item.type === 'url') {\n          item.url = item.value\n          item.type = 'web_url'\n          delete item.value\n        }\n        return item\n      })\n    }\n  }\n\n  _setupNewWebhook() {\n    const oAuthUrl = 'https://graph.facebook.com/v2.7/oauth/access_token' +\n      '?client_id=' + this.config.applicationID +\n      '&client_secret=' + this.config.appSecret +\n      '&grant_type=client_credentials'\n\n    const url = `https://graph.facebook.com/v2.7/${this.config.applicationID}/subscriptions?access_token=`\n\n    return fetch(oAuthUrl)\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .then(json => json.access_token)\n    .then(token => fetch(url + token, {\n      method: 'POST',\n      headers: {'Content-Type': 'application/json'},\n      body: JSON.stringify({\n        object: 'page',\n        callback_url: 'https://' + this.config.hostname + '/api/botpress-messenger/webhook',\n        verify_token: this.config.verifyToken,\n        fields: [\n          'message_deliveries',\n          'message_reads',\n          'messages',\n          'messaging_optins',\n          'messaging_postbacks',\n          'messaging_referrals'\n        ]\n      })\n    }))\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n  }\n\n  _subscribePage() {\n    const url = 'https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'POST' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n  _unsubscribePage() {\n    const url = 'https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=' + this.config.accessToken\n\n    return fetch(url, { method: 'DELETE' })\n    .then(this._handleFacebookResponse)\n    .then(res => res.json())\n    .catch(err => console.log(err))\n  }\n\n}\n\nmodule.exports = Messenger\n\n\n\n// WEBPACK FOOTER //\n// ./src/messenger.js","module.exports = require(\"eventemitter2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"eventemitter2\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"node-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-fetch\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 12\n// module chunks = 0","'use strict'\n\nconst _ = require('lodash')\n\nconst validateUserId = (userId) => {\n  if (!/[0-9]+/.test(userId)) {\n    throw new Error('Invalid userId')\n  }\n}\n\nconst validateText = (text) => {\n  if (typeof(text) !== 'string' || text.length > 300) {\n    throw new Error('Text must be a string less than 300 chars.')\n  }\n}\n\nconst validateQuickReplies = (quick_replies) => {\n  if (!_.isArray(quick_replies)) {\n    throw new Error('quick_replies must be an array')\n  }\n\n  _.forEach(quick_replies, validateQuickReply)\n}\n\nconst validateQuickReply = (quick_reply) => {\n  if (typeof(quick_reply) !== 'string') {\n    if (!quick_reply || typeof(quick_reply.title) !== 'string') {\n      throw new Error('Expected quick_reply to be a string or an object' +\n        'with a title.')\n    }\n  }\n}\n\nconst validateTyping = (typing) => {\n  if (!_.isBoolean(typing) && !_.isNumber(typing)) {\n    throw new Error('Expected typing to be a boolean of a number')\n  }\n}\n\nconst validateAttachmentType = (type) => {\n  if (typeof(type) !== 'string') {\n    throw new Error('Expected attachment type to be a text')\n  }\n\n  if (!_.includes(['image', 'video', 'audio', 'file'], type.toLowerCase())) {\n    throw new Error('Invalid attachment type')\n  }\n}\n\nconst validateUrl = (url) => {\n  if (typeof(url) !== 'string') {\n    throw new Error('Expected URL to be a string')\n  }\n}\n\nconst validateTemplatePayload = (payload) => {\n  if (!_.isPlainObject(payload)) {\n    throw new Error('Template payload must be a plain object')\n  }\n\n  if (typeof(payload.template_type) !== 'string') {\n    throw new Error('\"template_type\" must be set')\n  }\n}\n\nconst validatePersistentMenu = (elements) => {\n  if (!_.isArray(elements)) {\n    throw new Error('Expected elements to be an array')\n  }\n\n  _.forEach(elements, (element) => {\n    if (!_.isPlainObject(element)) {\n      throw new Error('Expected element to be a plain object')\n    }\n  })\n}\n\nconst createText = (userId, text, options) => {\n  validateUserId(userId)\n  validateText(text)\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return {\n    platform: 'facebook',\n    type: 'text',\n    text: text,\n    raw: {\n      to: userId,\n      message: text,\n      typing: (options && options.typing),\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  }\n}\n\nconst createAttachment = (userId, type, url, options) => {\n  validateUserId(userId)\n  validateAttachmentType(type)\n  \n  if( _.isNull(url) && !(options && options.attachmentId) ){\n    throw new Error('If URL is null, you must pass an attachment_id on options object')\n  }\n  else if( options && options.attachmentId ){\n    validateText(options.attachmentId)\n  }\n  else{\n    validateUrl(url);\n  }\n\n  if (options && options.quick_replies) {\n    validateQuickReplies(options.quick_replies)\n  }\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return {\n    platform: 'facebook',\n    type: 'attachment',\n    text: 'Attachment (' + type + ') : ' + url,\n    raw: {\n      to: userId,\n      type: type,\n      url: url,\n      isReusable: (options && options.isReusable),\n      attachmentId: (options && options.attachmentId),\n      typing: (options && options.typing),\n      quick_replies: options && options.quick_replies,\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  }\n}\n\nconst createTemplate = (userId, payload, options) => {\n  validateUserId(userId)\n  validateTemplatePayload(payload)\n\n  if (options && options.typing) {\n    validateTyping(options.typing)\n  }\n\n  return {\n    platform: 'facebook',\n    type: 'template',\n    text: 'Template (' + payload.template_type + ')',\n    raw: {\n      to: userId,\n      payload: payload,\n      typing: (options && options.typing),\n      waitRead: options && options.waitRead,\n      waitDelivery: options && options.waitDelivery\n    }\n  }\n}\n\nconst createTyping = (userId, typing) => {\n  validateUserId(userId)\n  validateTyping(typing)\n\n  return {\n    platform: 'facebook',\n    type: 'typing',\n    text: 'Typing: ' + typing,\n    raw: {\n      to: userId,\n      typing: typing\n    }\n  }\n}\n\nconst createSeen = (userId) => {\n  validateUserId(userId)\n\n  return {\n    platform: 'facebook',\n    type: 'seen',\n    text: 'Mark as seen',\n    raw: {\n      to: userId\n    }\n  }\n}\n\nconst createPersistentMenu = (elements) => {\n  if (!elements) {\n    return {\n      platform: 'facebook',\n      type: 'persistent_menu',\n      text: 'Delete the persistent menu',\n      raw: {\n        delete: true\n      }\n    }\n  }\n\n  validatePersistentMenu(elements)\n  return {\n    platform: 'facebook',\n    type: 'persistent_menu',\n    text: 'Set persistent menu: ' + elements.length + ' items',\n    raw: {\n      delete: false,\n      elements: elements\n    }\n  }\n}\n\nconst createGreetingText = (text) => {\n  if (text && text.length > 160) {\n    throw new Error('Greeting text must be less than 160 chars')\n  }\n\n  return {\n    platform: 'facebook',\n    type: 'greeting_text',\n    text: 'Set greeting text: ' + text,\n    raw: {\n      text: text\n    }\n  }\n}\n\nconst createGetStarted = (postback) => {\n  return {\n    platform: 'facebook',\n    type: 'get_started',\n    text: 'Setting get started button: ' + !!postback,\n    raw: {\n      enabled: !!postback,\n      postback: postback\n    }\n  }\n}\n\nconst createWhitelistedDomains = (domains) => {\n  if (domains && !_.every(domains, _.isString)) {\n    throw new Error('Expected domains to be a list of string')\n  }\n\n  return {\n    platform: 'facebook',\n    type: 'whitelisted_domains',\n    text: 'Setting whitelisted domains',\n    raw: {\n      domains: domains\n    }\n  }\n}\n\nmodule.exports = {\n  createText,\n  createAttachment,\n  createTemplate,\n  createTyping,\n  createSeen,\n  createGetStarted,\n  createPersistentMenu,\n  createGreetingText,\n  createWhitelistedDomains\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/actions.js","const handlePromise = (next, promise) => {\n  return promise.then(res => {\n    next()\n    return res\n  })\n  .catch(err => {\n    next(err)\n    throw err\n  })\n}\n\nconst handleText = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTextMessage(\n    event.raw.to,\n    event.raw.message,\n    event.raw.quick_replies,\n    event.raw))\n}\n\nconst handleAttachment = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendAttachment(\n    event.raw.to,\n    event.raw.type,\n    event.raw.url,\n    event.raw.quick_replies,\n    event.raw))\n}\n\nconst handleTemplate = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTemplate(\n    event.raw.to,\n    event.raw.payload,\n    event.raw))\n}\n\nconst handleTyping = (event, next, messenger) => {\n  return handlePromise(next, messenger.sendTypingIndicator(\n    event.raw.to,\n    event.raw.typing))\n}\n\nconst handleSeen = (event, next, messenger) => {\n  return handlePromise(next, \n    messenger.sendAction(event.raw.to, 'mark_seen'))\n}\n\nconst handleGetStarted = (event, next, messenger) => {\n  if (event.raw.enabled) {\n    return handlePromise(next, \n      messenger.setGetStartedButton(event.raw.postback))\n  } else {\n    return handlePromise(next, messenger.deleteGetStartedButton())\n  }\n}\n\nconst handlePersistentMenu = (event, next, messenger) => {\n  if (event.raw.delete) {\n    return handlePromise(next, messenger.deletePersistentMenu())\n  } else {\n    return handlePromise(next, \n      messenger.setPersistentMenu(event.raw.elements))\n  }\n}\n\nconst handleGreetingText = (event, next, messenger) => {\n  if (event.raw.text) {\n    return handlePromise(next, \n      messenger.setGreetingText(event.raw.text))\n  } else {\n    return handlePromise(next, messenger.deleteGreetingText(event.raw.text))\n  }\n}\n\nconst handleWhitelistedDomains = (event, next, messenger) => {\n  return handlePromise(next, \n    messenger.setWhitelistedDomains(event.raw.domains))\n}\n\nmodule.exports = {\n  'text': handleText,\n  'attachment': handleAttachment,\n  'template': handleTemplate,\n  'typing': handleTyping,\n  'seen': handleSeen,\n  'greeting_text': handleGreetingText,\n  'persistent_menu': handlePersistentMenu,\n  'whitelisted_domains': handleWhitelistedDomains,\n  'get_started': handleGetStarted,\n  pending: {}\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/outgoing.js","import LRU from 'lru-cache'\n\nimport Users from './users'\nimport outgoing from './outgoing'\nimport _ from 'lodash'\n\nmodule.exports = (bp, messenger) => {\n\n  const users = Users(bp, messenger)\n\n  const messagesCache = LRU({\n    max: 10000,\n    maxAge: 60 * 60 * 1000\n  })\n\n  const preprocessEvent = payload => {\n    const userId = payload.sender.id\n    const mid = payload.message && payload.message.mid\n\n    if (mid && !messagesCache.has(mid)) {\n      // We already processed this message\n      payload.alreadyProcessed = true\n    } else {\n      // Mark it as processed\n      messagesCache.set(mid, true)\n    }\n\n    return users.getOrFetchUserProfile(userId)\n  }\n\n  messenger.on('message', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      // push the message to the incoming middleware\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'message',\n        user: profile,\n        text: e.message.text,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('attachment', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'attachments',\n        user: profile,\n        text: e.message.attachments.length + ' attachments',\n        raw: e\n      })\n      e.message.attachments.forEach(att => {\n        bp.middlewares.sendIncoming({\n          platform: 'facebook',\n          type: att.type,\n          user: profile,\n          text: att.payload.url ?\n            att.payload.url\n            : JSON.stringify(att.payload),\n          raw: att\n        })\n      })\n    })\n  })\n\n  messenger.on('postback', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'postback',\n        user: profile,\n        text: e.postback.payload,\n        raw: e\n      })\n\n      if (e.postback.payload === 'GET_STARTED') {\n        const mConfig = messenger.getConfig()\n\n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponseText') {\n          bp.messenger.sendText(profile.id, mConfig.autoResponseText)\n        }\n        \n        if (mConfig.displayGetStarted && mConfig.autoResponseOption == 'autoResponsePostback') {\n          bp.middlewares.sendIncoming({\n            platform: 'facebook',\n            type: 'postback',\n            user: profile,\n            text: mConfig.autoResponsePostback,\n            raw: e\n          })\n        }\n      }\n    })\n  })\n\n  messenger.on('quick_reply', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'quick_reply',\n        user: profile,\n        text: e.message.quick_reply.payload,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('delivery', e => {\n\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient && pending.event.raw.waitDelivery) {\n        if (_.includes(e.delivery.mids, pending.mid)) {\n          pending.resolve(e)\n          delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'delivery',\n        user: profile,\n        text: e.delivery.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('read', e => {\n\n    _.values(outgoing.pending).forEach(pending => {\n      const recipient = pending.event.raw.to\n      if (e.sender.id === recipient) {\n        if (pending.event.raw.waitRead\n          && pending.timestamp\n          && pending.timestamp <= e.read.watermark) {\n          pending.resolve(e)\n          delete outgoing.pending[pending.event.__id]\n        }\n      }\n    })\n\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'read',\n        user: profile,\n        text: e.read.watermark.toString(),\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('account_linking', () => {\n    bp.logger.warn('[messenger] ACCOUNT_LINKING NOT IMPLEMENTED, Your pull requests are welcome :)')\n  })\n\n  messenger.on('optin', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'optin',\n        user: profile,\n        text: e.optin.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('referral', e => {\n    preprocessEvent(e)\n    .then(profile => {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'referral',\n        user: profile,\n        text: e.referral.ref,\n        raw: e\n      })\n    })\n  })\n\n  messenger.on('payment', e=> {\n    preprocessEvent(e)\n    .then(profile=> {\n      bp.middlewares.sendIncoming({\n        platform: 'facebook',\n        type: 'payment',\n        text: 'payment',\n        user: profile,\n        payment: e.payment,\n        raw: e\n      })\n    })\n  })\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/incoming.js","module.exports = require(\"lru-cache\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lru-cache\"\n// module id = 16\n// module chunks = 0","'use strict'\n\n/**\n *\n * User info helper.\n *\n * This helper provides following methods:\n *\n *   - getOrFetchUserProfile: given `userId` return a promise of user data (with cache)\n *\n * Data users' profiles will be cached in `${bp.dataLocation}/botpress-messenger.profiles.json`\n *\n */\n\nconst Promise = require('bluebird')\nconst path = require('path')\nconst fs = require('fs')\n\nmodule.exports = function(bp, messenger) {\n\n  const filename = path.join(\n    bp.dataLocation,\n    'botpress-messenger.profiles.json'\n    )\n\n  const loadUserProfiles = () => {\n    if (fs.existsSync(filename)) {\n      return JSON.parse(fs.readFileSync(filename))\n    }\n    return {}\n  }\n\n  const saveUserProfiles = (profiles) => {\n    const content = JSON.stringify(profiles)\n    fs.writeFileSync(filename, content)\n    bp.logger.debug('messenger: saved user profiles to disk')\n  }\n\n  const userProfiles = loadUserProfiles()\n  let cacheTs = new Date()\n\n  return {\n    getOrFetchUserProfile: Promise.method((userId) => {\n      if (userProfiles[userId]) {\n        return userProfiles[userId]\n      }\n\n      return messenger.getUserProfile(userId)\n      .then((profile) => {\n        profile.id = userId\n        userProfiles[userId] = profile\n        if (new Date() - cacheTs >= 10000) {\n          saveUserProfiles(userProfiles)\n          cacheTs = new Date()\n        }\n\n        return bp.db.saveUser({\n          id: profile.id,\n          platform: 'facebook',\n          gender: profile.gender,\n          timezone: profile.timezone,\n          locale: profile.locale,\n          picture_url: profile.profile_pic,\n          first_name: profile.first_name,\n          last_name: profile.last_name\n        }).return(profile)\n\n      })\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/users.js","'use strict'\n\nconst Promise = require('bluebird')\nconst ngrok = require('ngrok')\nlet url = null\n\nmodule.exports = {\n  getUrl: (port) => {\n    if (url) {\n      return Promise.resolve(url)\n    }\n\n    return Promise.fromCallback(callback => {\n      ngrok.connect(port || 3000, callback)\n    })\n    .then(u => url = u)\n  },\n  stop: () => {\n    if (url) {\n      ngrok.disconnect(url)\n      url = null\n    }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/ngrok.js","module.exports = require(\"ngrok\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"ngrok\"\n// module id = 19\n// module chunks = 0"],"sourceRoot":""}